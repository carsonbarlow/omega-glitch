!function(){function s(s,t,e,o){j.beginPath(),j.moveTo(s,t),j.lineTo(e,o),j.closePath(),j.stroke()}function t(){this.points=[{y:Math.floor(Math.random()*O+1)*v,x:Math.floor(Math.random()*C+1)*v}],this.draw=o,this.move=e,this.dir=Math.floor(8*Math.random()+1)}function e(){var s=Math.floor(3*Math.random()-1),t=this.dir+s;t<0&&(t=7),7<t&&(t=0);var e=this.points[this.points.length-1];e.x<10&&(t=2),e.y<10&&(t=4),u.width-10<e.x&&(t=6),u.height-10<e.y&&(t=0),this.dir=t;var o={x:e.x+S[t].x*v,y:e.y+S[t].y*v};this.points.push(o),10<this.points.length&&this.points.shift()}function o(){var s=this.points;for(m=1;m<s.length;m++)d.beginPath(),d.moveTo(s[m-1].x,s[m-1].y),d.lineTo(s[m].x,s[m].y),d.closePath(),d.lineWidth=1,d.strokeStyle=w,d.stroke(),d.lineWidth=10,d.strokeStyle=b,d.stroke()}function a(s){this.snakeys=[];for(var e=0;e<s;e++)this.snakeys.push(new t);this.go=i}function i(){for(var s=0;s<this.snakeys.length;s++)this.snakeys[s].move(),this.snakeys[s].draw()}var n,r=function(){function s(){v.charges&&(v.charges--,c.detonate_charge(u))}function t(){var s=utils.normalize(v.pos_x,v.pos_y,f[g].x,f[g].y);v.vol_x=s[0]*v.speed,v.vol_y=s[1]*v.speed}function e(s){function e(){v.pos_x=f[g].x,v.pos_y=f[g].y,g++,g>=f.length?o(next_spot):t()}y&&(v.pos_x+=v.vol_x*s,v.pos_y+=v.vol_y*s,v.vol_x>0&&v.pos_x>f[g].x?e():v.vol_x<0&&v.pos_x<f[g].x&&e(),v.vol_y>0&&v.pos_y>f[g].y?e():v.vol_y<0&&v.pos_y<f[g].y&&e())}function o(s){u=s,y=!1,v.pos_x=s.pos_x,v.pos_y=s.pos_y,s.charge&&(v.charges++,s.charge=!1),v.collision=8}function a(){o(c.starting_spot)}function i(s){e(s)}function n(){return v}function r(s){p=s,p.add_subscriber(this)}function h(e){if(!y){if(" "===e)return void s();var o=c.move_leads_to(u,d[e]);o&&(f=o.path.checkpoints.slice(0),f[0].x===v.pos_x&&f[0].y===v.pos_y||f.reverse(),g=1,next_spot=o.spot,t(),y=!0,v.collision=2)}}function l(s){c=s}function _(s){v.charges=s}var p,c,f,g,u,d={a:"west",s:"south",d:"east",w:"north"},v={pos_x:0,pos_y:0,vol_x:0,vol_y:0,speed:500,charges:0,collision:10,radius:10,graphic:{lineWidth:0,fillStyle:"rgba(250,247,91,0.7)",strokeStyle:"#29c8df",shadowColor:"#39b5a6",shadowBlur:5,shadowOffsetX:0,shadowOffsetY:0}},y=!1;this.update=i,this.get_avatar=n,this.start_level=a,this.inject_input=r,this.key_pressed=h,this.inject_level_manager=l,this.set_avatar_charges=_},h={canvas_id:"game_canvas",fps:60,grid_size:15,FOREGROUND:1,BACKGROUND:0,direction_to_grid_difference:{1:{x:0,y:-1},2:{x:1,y:-1},3:{x:1,y:0},4:{x:1,y:1},5:{x:0,y:1},6:{x:-1,y:1},7:{x:-1,y:0},8:{x:-1,y:-1}}};window.onload=function(s){n=new l};var l=function(){function s(s){_&&t.update(s)}var t=new p;graphics=new g,input=new M,t.inject_graphics(graphics),t.inject_input(input);var e=function(){var t=1e3/h.fps;next_tick=last_tick=(new Date).getTime();return num_frames=0,function(){for(current_tick=(new Date).getTime();current_tick>next_tick;)delta=(current_tick-last_tick)/1e3,s(delta),next_tick+=t,last_tick=(new Date).getTime();graphics.draw(),num_frames++}}();window.requestAnimationFrame?window.each_frame=function(s){var t=function(){s(),requestAnimationFrame(t)};t()}:window.mozRequestAnimationFrame?window.each_frame=function(s){var t=function(){s(),mozRequestAnimationFrame(t)};t()}:window.each_frame=function(s){setInterval(s,1e3/h.fps)},window.each_frame(e),t.start_game()},_=!1,p=function(){function s(s){c.update(s),level_manager.update(s)}function t(s){h=s,h.inject_avatar(c.get_avatar()),level_manager.inject_graphics(s)}function e(s){l=s,c.inject_input(s)}function o(){p=1,a()}function a(){level_manager.clear_level(),level_manager.setup_level(p),c.start_level(),_=!0}function i(){setTimeout(function(){_=!1,p++,a()},1e3)}function n(){_=!1,a()}var h,l,p,c=new r;level_manager=new B,c.inject_level_manager(level_manager),level_manager.inject_avatar_manager(c),level_manager.inject_game_master(this),this.update=s,this.inject_graphics=t,this.inject_input=e,this.start_game=o,this.level_complete=i,this.reset_level=n},c=function(s){function t(){}this.pos_x=s.x*h.grid_size,this.pos_y=s.y*h.grid_size,this.path=s.p,this.size=10,this.blow_up=t,this.graphic={lineWidth:1,fillStyle:"rgba(204, 51, 51, 0.6)",shadowColor:"#6FC3DF",shadowBlur:5,shadowOffsetX:0,shadowOffsetY:0}},f=function(s,t){function e(){}this.spot=t[s.s],this.gates=s.g,this.gate_paths=s.gp,this.pos_x=this.spot.pos_x,this.pos_y=this.spot.pos_y,this.size=10,this.blow_up=e,this.graphic={lineWidth:1,fillStyle:"rgba(204, 104, 51, 0.6)",shadowColor:"#6FC3DF",shadowBlur:5,shadowOffsetX:0,shadowOffsetY:0}},g=function(){function s(){u.clearRect(0,0,d,v),_();for(var s=0;s<y.length;s++)i(y[s]);u.font="bold 20px sans-serif",u.fillStyle="rgba(210,210,210,0.5)",u.fillText("Charges:"+c.charges,33,27)}function t(s){c=s}function e(){for(var s in f)f[s]=[];f.avatar=[c]}function o(s,t){var e=f[t];e.indexOf(s)==-1&&e.push(s)}function a(s,t){var e=f[t];e.indexOf(s)!=-1&&e.splice(e.indexOf(s),1)}function i(s){for(var t=f[s],e=0;e<t.length;e++){u.save();var o=t[e].graphic;for(var a in o)u[a]=o[a];x[s](t[e]),u.restore()}}function n(s){u.beginPath(),u.arc(s.pos_x,s.pos_y,s.collision,0,2*Math.PI,!0),u.fill(),u.stroke(),s.charge&&l(s)}function r(s){var t=s.pos_x,e=s.pos_y,o=s.size;u.beginPath(),u.moveTo(t-o,e-o),u.lineTo(t+o,e-o),u.lineTo(t+o,e+o),u.lineTo(t-o,e+o),u.lineTo(t-o,e-o),u.fill(),u.stroke()}function l(s){u.fillStyle="rgba(212, 17, 27, 0.6)",u.shadowColor="#d0161e",u.shadowBlur=10,u.shadowOffsetX=0,u.shadowOffsetY=0,u.beginPath(),u.arc(s.pos_x,s.pos_y,4,0,2*Math.PI,!0),u.fill()}function _(){u.save(),u.lineWidth=2,u.strokeStyle="#d1f3f8",u.shadowColor="#6FC3DF",u.shadowBlur=5,u.shadowOffsetX=0,u.shadowOffsetY=0;for(var s=0;s<f.paths.length;s++)p(f.paths[s]);u.restore()}function p(s){u.moveTo(s[0].x,s[0].y);for(var t=1;t<s.length;t++)u.lineTo(s[t].x,s[t].y);u.stroke()}var c,f={spots:[],paths:[],objectives:[],patrols:[],patrol_generators:[],gates:[],gate_generators:[],avatar:[]},g=document.getElementById(h.canvas_id),u=g.getContext("2d"),d=g.width,v=g.height,y=["spots","objectives","patrols","patrol_generators","gates","gate_generators","avatar"],x={spots:n,objectives:r,patrols:n,patrol_generators:r,gates:r,gate_generators:r,avatar:n};this.draw=s,this.clear_level=e,this.inject_avatar=t,this.add_to_manifest=o,this.remove_from_manifest=a},u=document.getElementById("text");u.width=window.innerWidth,u.height=window.innerHeight;var d=u.getContext("2d");d.translate(.5,.5);var v=12,y="rgba(240,240,240)",x="rgba(0,20,40,0.9)",w="rgba(0,255,255,0.1)",b="rgba(0,100,100,0.1)",k=document.createElement("canvas");k.width=window.innerWidth,k.height=window.innerHeight;var j=k.getContext("2d");j.translate(.5,.5),j.fillStyle=y,j.fillRect(0,0,k.width,k.height);var O=Math.ceil(k.height/v),C=Math.ceil(k.width/v);j.strokeStyle=x;for(var z=1;z<=C;z++)s(z*v,0,z*v,k.height);for(var F=0;F<=O;F++)s(0,F*v,k.width,F*v);for(var F=0;F<=O+C;F++)s(0,F*v-k.width,k.width,F*v),s(0,F*v,k.width,F*v-k.width);var S=[{name:"up",x:0,y:-1},{name:"upright",x:1,y:-1},{name:"right",x:1,y:0},{name:"downright",x:1,y:1},{name:"down",x:0,y:1},{name:"downleft",x:-1,y:1},{name:"left",x:-1,y:0},{name:"upleft",x:-1,y:-1}],T=new a(10);d.drawImage(k,0,0),setInterval(function(){d.globalAlpha=.2,d.drawImage(k,0,0),d.globalAlpha=1,T.go()},1e3/30);var M=function(){function s(s){e.indexOf(s)===-1&&e.push(s)}function t(s){e.indexOf(s)!==-1&&s.splice(e.indexOf(s),1)}var e=[];window.addEventListener("keydown",function(s){for(var t=0;t<e.length;t++)e[t].key_pressed(s.key)}),this.add_subscriber=s,this.remove_subscriber=t},B=function(){function s(s){h=A.levels[String(s)],_.set_avatar_charges(h.charges);for(var t in h.spots){var e=new Y(h.spots[t]);g[t]=e,l.add_to_manifest(e,"spots")}for(this.starting_spot=g[h.start],F=0;F<h.paths.length;F++){var o=new D(h.paths[F]);o.inject_graphics(l),o.set_starting_spot(g[h.paths[F][0]]),u.push(o)}for(F=0;F<h.objectives.length;F++){var a=new W(h.objectives[F],g);l.add_to_manifest(a,"objectives"),d.push(a)}for(F=0;F<h.patrols.length;F++){var i=new P(h.patrols[F]);i.make_path_list(u,g),i.inject_graphics(l),v.push(i)}for(F=0;F<h.patrol_generators.length;F++){var n=new X(h.patrol_generators[F],g);l.add_to_manifest(n,"patrol_generators"),y.push(n)}for(F=0;F<h.gates.length;F++){var r=new c(h.gates[F]);u[r.path].blocked=!0,l.add_to_manifest(r,"gates"),x.push(r)}for(F=0;F<h.gate_generators.length;F++){var p=new f(h.gate_generators[F],g);l.add_to_manifest(p,"gate_generators"),w.push(p)}}function t(s,t){if(!s[t])return!1;var e={spot:g[s[t][0]],path:u[s[t][1]]};return!e.path.blocked&&e}function e(s){l=s}function o(s){_=s}function a(s){p=s}function i(s){for(var t=0;t<d.length;t++)if(d[t].spot==s){d[t].blow_up(),l.remove_from_manifest(d[t],"objectives");for(var e=d[t].paths.length-1;e>-1;e--){u[d[t].paths[e]].blow_up();for(var o=0;o<v.length;o++)v[o].get_current_path()===u[d[t].paths[e]]&&v[o].blow_up()}d.splice(t,1),d.length||p.level_complete()}for(t=0;t<y.length;t++)if(y[t].spot==s){y[t].blow_up();for(var o=y[t].patrols.length-1;o>-1;o--)v[y[t].patrols[o]].blow_up(),l.remove_from_manifest(v[y[t].patrols[o]].get_unit(),"patrols");l.remove_from_manifest(y[t],"patrol_generators")}for(t=0;t<w.length;t++)if(w[t].spot==s){w[t].blow_up();for(var a=w[t].gates.length-1;a>-1;a--)x[w[t].gates[a]].blow_up(),l.remove_from_manifest(x[w[t].gates[a]],"gates"),u[x[w[t].gates[a]].path].blocked=!1,l.remove_from_manifest(w[t],"gate_generators")}}function n(){l.clear_level(),g={},u=[],d=[],v=[],y=[],x=[],w=[]}function r(s){for(var t=0;t<v.length;t++)v[t].update(s),v[t].is_active()&&utils.check_collision(v[t].get_unit(),_.get_avatar())&&p.reset_level()}var h,l,_,p,g,u,d,v,y,x,w;this.starting_spot,this.setup_level=s,this.inject_graphics=e,this.inject_avatar_manager=o,this.inject_game_master=a,this.move_leads_to=t,this.detonate_charge=i,this.clear_level=n,this.update=r},W=function(s,t){function e(){}this.spot=t[s[0]],this.paths=s[1],this.size=15,this.pos_x=this.spot.pos_x,this.pos_y=this.spot.pos_y,this.graphic={lineWidth:1,fillStyle:"rgba(250,247,91,0.2)",shadowColor:"#6FC3DF",shadowBlur:5,shadowOffsetX:0,shadowOffsetY:0},this.blow_up=e},D=function(s){function t(s){n=s,this.checkpoints=o(),i.add_to_manifest(r,"paths")}function e(s){i=s}function o(){r=[],r.push({x:n.pos_x,y:n.pos_y});for(var t,e,o=1;o<s.length;o+=2)t=s[o],e=s[o+1],r.push({x:h.direction_to_grid_difference[t].x*h.grid_size*e+r[r.length-1].x,y:h.direction_to_grid_difference[t].y*h.grid_size*e+r[r.length-1].y});return r}function a(){i.remove_from_manifest(r,"paths"),this.blocked=!0,this.blown_up=!0}var i,n,r;this.set_starting_spot=t,this.inject_graphics=e,this.checkpoints=r,this.blow_up=a},P=function(s){function t(s){c=s,c.add_to_manifest(x,"patrols")}function e(s,t){f=[];for(var e=0;e<y.length;e++)f.push(s[o(t[y[e]],y[(e+1)%y.length])]);x.pos_x=t[y[0]].pos_x,x.pos_y=t[y[0]].pos_y,u=-1,d=1,n()}function o(s,t){for(var e=0;e<m.length;e++)if(s[m[e]]&&s[m[e]][0]==t)return s[m[e]][1]}function a(s){w&&i(s)}function i(s){function t(){x.pos_x=g[v].x,x.pos_y=g[v].y,v++,v>=g.length?n():r()}x.pos_x+=x.vol_x*s,x.pos_y+=x.vol_y*s,x.vol_x>0&&x.pos_x>g[v].x?t():x.vol_x<0&&x.pos_x<g[v].x&&t(),x.vol_y>0&&x.pos_y>g[v].y?t():x.vol_y<0&&x.pos_y<g[v].y&&t()}function n(){u=(u+d+y.length)%y.length,g=f[u],g.blown_up&&(d=-d,u=(u+2*d+y.length)%y.length,g=f[u]),g=g.checkpoints.slice(0),g[0].x===x.pos_x&&g[0].y===x.pos_y||g.reverse(),v=1,r()}function r(){var s=utils.normalize(x.pos_x,x.pos_y,g[v].x,g[v].y);x.vol_x=s[0]*x.speed,x.vol_y=s[1]*x.speed}function h(){return x}function l(){return w}function _(){w=!1}function p(){return f[u]}var c,f,g,u,d,v,y=s,x={pos_x:0,pos_y:0,vol_x:0,vol_y:0,speed:75,collision:10,graphic:{lineWidth:0,fillStyle:"rgba(207, 19, 28, 0.8)",shadowColor:"#6FC3DF",shadowBlur:20,shadowOffsetX:0,shadowOffsetY:0}},w=!0,m=["north","east","west","south"];this.make_path_list=e,this.update=a,this.inject_graphics=t,this.get_unit=h,this.get_current_path=p,this.blow_up=_,this.is_active=l},X=function(s,t){function e(){}this.spot=t[s.s],this.patrols=s.p,this.pos_x=this.spot.pos_x,this.pos_y=this.spot.pos_y,this.size=10,this.blow_up=e,this.graphic={lineWidth:1,fillStyle:"rgba(84, 84, 51, 0.6)",shadowColor:"#6FC3DF",shadowBlur:5,shadowOffsetX:0,shadowOffsetY:0}},Y=function(s){this.pos_x=s.x*h.grid_size,this.pos_y=s.y*h.grid_size,this.north=s.n,this.east=s.e,this.south=s.s,this.west=s.w,this.charge=s.charge||!1,this.collision=h.grid_size/2,this.graphic={fillStyle:"rgba(254, 254, 254, 0.8)",lineWidth:2,strokeStyle:"#29c8df",shadowColor:"#5ad4e6",shadowBlur:10,shadowOffsetX:0,shadowOffsetY:0}},I=function(){function s(s,t,e,o){x_dif=e-s,y_dif=o-t;var a=x_dif*x_dif+y_dif*y_dif;return a=Math.sqrt(a),[x_dif/a,y_dif/a]}function t(s,t){return e(s,t)<s.collision+t.collision}function e(s,t){var e=s.pos_x-t.pos_x,o=s.pos_y-t.pos_y;return Math.sqrt(e*e+o*o)}this.normalize=s,this.check_collision=t};utils=new I;var A=A||{levels:{}};A.levels[1]={charges:1,spots:{s1:{x:8,y:15,e:["s2",0]},s2:{x:20,y:15,w:["s1",0],e:["s3",1]},s3:{x:35,y:15,w:["s2",1]}},paths:[["s1",3,12],["s2",3,15]],patrols:[],patrol_generators:[],start:"s1",objectives:[["s3",[0,1]]],gates:[],gate_generators:[]};var A=A||{levels:{}};A.levels[2]={charges:0,spots:{s1:{x:8,y:15,e:["s2",0]},s2:{x:20,y:15,w:["s1",0],e:["s3",1],n:["s4",2]},s3:{x:35,y:15,w:["s2",1],charge:!0},s4:{x:20,y:10,s:["s2",2]}},paths:[["s1",3,12],["s2",3,15],["s2",1,5]],patrols:[],patrol_generators:[],start:"s1",objectives:[["s4",[0,1,2]]],gates:[],gate_generators:[]};var A=A||{levels:{}};A.levels[3]={charges:1,spots:{s1:{x:8,y:15,e:["s2",0]},s2:{x:12,y:15,w:["s1",0],e:["s4",1],n:["s3",2]},s3:{x:12,y:10,s:["s2",2]},s4:{x:16,y:15,w:["s2",1],e:["s5",3]},s5:{x:20,y:15,w:["s4",3],e:["s6",4]},s6:{x:24,y:15,w:["s5",4],e:["s7",5],s:["s8",6]},s7:{x:30,y:11,s:["s6",5]},s8:{x:30,y:19,w:["s6",6]}},paths:[["s1",3,4],["s2",3,4],["s2",1,5],["s4",3,4],["s5",3,4],["s6",3,3,2,3,1,1],["s6",5,2,4,2,3,4]],start:"s1",objectives:[["s7",[0,1,2,3,4,5,6]]],patrols:[["s3","s2","s4","s5","s6","s8","s6","s5","s4","s2"]],patrol_generators:[{s:"s8",p:[0]}],gates:[],gate_generators:[]};var A=A||{levels:{}};A.levels[4]={charges:2,spots:{s1:{x:9,y:7,s:["s2",0]},s2:{x:10,y:12,n:["s1",0],e:["s3",1]},s3:{x:14,y:12,w:["s2",1],e:["s4",2],n:["s7",5]},s4:{x:22,y:14,w:["s3",2],e:["s5",3],s:["s6",4]},s5:{x:25,y:11,s:["s4",3]},s6:{x:20,y:17,e:["s4",4]},s7:{x:20,y:8,w:["s3",5]}},paths:[["s1",5,2,4,1,5,2],["s2",3,4],["s3",3,2,4,2,3,4],["s4",3,2,2,1,1,2],["s4",5,2,6,1,7,1],["s3",1,2,2,2,3,4]],start:"s1",objectives:[["s5",[0,1,2,3,4,5]]],patrols:[["s6","s4","s3","s4"]],patrol_generators:[{s:"s6",p:[0]}],gates:[{x:20,y:14,p:2}],gate_generators:[{s:"s7",g:[0],gp:[[5,6]]}]};var A=A||{levels:{}};A.levels[5]={charges:1,spots:{s1:{x:8,y:20,n:["s2",0]},s2:{x:9,y:13,s:["s1",0],n:["s3",1],e:["s4",2]},s3:{x:6,y:12,n:["s2",1],charge:!0},s4:{x:16,y:15,w:["s2",2],s:["s5",3],e:["s7",6]},s5:{x:15,y:20,n:["s4",3],s:["s6",4]},s6:{x:22,y:20,w:["s5",4],n:["s7",5]},s7:{x:19,y:15,w:["s4",6],s:["s6",5],e:["s8",7]},s8:{x:23,y:10,s:["s7",7],w:["s9",8]},s9:{x:19,y:11,e:["s8",8]}},paths:[["s1",1,3,2,1,1,3],["s2",1,2,2,1,1,3,8,1,7,3,6,1,5,2,4,1,5,2],["s2",3,2,4,2,3,3],["s4",5,2,6,1,5,2],["s5",5,1,6,9,3,1,2,10,3,1,6,10,3,1,2,10,3,1,6,10,3,1,2,10,3,1],["s6",1,1,8,3,1,1],["s4",3,3],["s7",3,2,2,2,1,3],["s8",7,2,6,1,7,1]],start:"s1",objectives:[["s8",[0,1,2,3,4,5,6,7,8]]],patrols:[["s5","s4","s7","s6"]],patrol_generators:[{s:"s5",p:[0]}],gates:[{x:18,y:15,p:6}],gate_generators:[{s:"s9",g:[0],gp:[[5,6]]}]};var A=A||{levels:{}};A.levels[6]={charges:3,spots:{s1:{x:28,y:18,n:["s2",0]},s2:{x:20,y:14,e:["s1",0],s:["s3",1]},s3:{x:8,y:18,n:["s2",1],w:["s4",2]},s4:{x:4,y:10,s:["s3",2],n:["s5",3],e:["s9",8]},s5:{x:9,y:4,w:["s4",3],e:["s6",4],n:["s10",9]},s6:{x:15,y:4,w:["s5",4],n:["s7",5]},s7:{x:22,y:1,w:["s6",5],s:["s8",6]},s8:{x:19,y:8,e:["s7",6],w:["s9",7]},s9:{x:14,y:9,e:["s8",7],w:["s4",8]},s10:{x:6,y:1,e:["s5",9]}},paths:[["s1",1,2,8,2,7,6],["s2",5,3,6,2,8,2,1,3,7,6,6,2,5,2],["s3",7,2,8,2,1,6],["s4",1,3,2,3,3,2],["s5",3,6],["s6",1,2,2,1,3,6],["s7",5,6,6,1,7,2],["s8",7,2,6,1,7,2],["s9",7,6,6,1,7,3],["s5",1,2,8,1,7,2]],start:"s1",objectives:[["s4",[1,2,3,4,8,7,6]],["s7",[5,4,9,3]]],patrols:[["s10","s5","s6","s7","s8","s9","s4","s5"],["s8","s9","s4","s5","s10","s5","s6","s7"]],patrol_generators:[{s:"s10",p:[0,1]}],gates:[{x:11,y:9,p:8}],gate_generators:[{s:"s9",g:[0]}]}}();