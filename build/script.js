!function(){var AvatarManager=function(){function e(){y.charges&&(y.charges--,d.detonate_charge(f))}function t(){var e=utils.normalize(y.pos_x,y.pos_y,u[v].x,u[v].y);y.vol_x=e[0]*y.speed,y.vol_y=e[1]*y.speed}function s(e){function s(){y.pos_x=u[v].x,y.pos_y=u[v].y,v++,v>=u.length?n(next_spot):t()}if(x)return y.pos_x+=y.vol_x*e,y.pos_y+=y.vol_y*e,y.vol_x>0&&y.pos_x>u[v].x?void s():y.vol_x<0&&y.pos_x<u[v].x?void s():void(u[v]&&y.vol_y>0&&y.pos_y>u[v].y?s():y.vol_y<0&&y.pos_y<u[v].y&&s())}function n(e){f=e,x=!1,y.pos_x=e.pos_x,y.pos_y=e.pos_y,e.charge&&(y.charges++,e.charge=!1),y.collision=8,b=!1}function a(){n(d.starting_spot)}function o(e){s(e)}function r(){return y}function i(){return b}function l(e){p=e,p.add_subscriber(this)}function _(s){if(!x&&level_ready){if(" "===s)return void e();var n=d.move_leads_to(f,m[s]);n&&(u=n.path.checkpoints.slice(0),u[0].x===y.pos_x&&u[0].y===y.pos_y||u.reverse(),v=1,next_spot=n.spot,t(),x=!0,b=!1,y.collision=4)}}function h(e){d=e}function g(e){y.charges=e}function c(){b=!0,u.reverse(),v=u.length-1-v,t(),next_spot=f}var p,d,u,v,f,m={a:"west",s:"south",d:"east",w:"north"},y={pos_x:0,pos_y:0,vol_x:0,vol_y:0,speed:500,charges:0,collision:10,radius:10,graphic:{lineWidth:0,fillStyle:"rgba(12,20,31,0.7)",strokeStyle:"#29c8df",shadowColor:"#39b5a6",shadowBlur:5,shadowOffsetX:0,shadowOffsetY:0}},x=!1,b=!1;this.update=o,this.get_avatar=r,this.start_level=a,this.inject_input=l,this.key_pressed=_,this.button_pressed=function(){},this.inject_level_manager=h,this.set_avatar_charges=g,this.get_gate_hit=i,this.hit_gate=c},CONFIG={canvas_id:"game_canvas",fps:60,grid_width:40,grid_height:30,grid_size:15,direction_to_grid_difference:{1:{x:0,y:-1},2:{x:1,y:-1},3:{x:1,y:0},4:{x:1,y:1},5:{x:0,y:1},6:{x:-1,y:1},7:{x:-1,y:0},8:{x:-1,y:-1}},level_button_width:5},DomManager=function(){function e(e){u[e].classList.add("hidden")}function t(e){u[e].classList.remove("hidden")}function s(e){for(var t=1;t<=e;t++){var s=document.getElementById("level_"+t);s.disabled=!1}}function n(e){v.innerHTML="";for(var t=0;t<e.length;t++){var s=document.createElement("div");s.classList.add("play_tip"),s.style.left=e[t].pos_x+"px",s.style.top=e[t].pos_y+"px",s.textContent=e[t].tip_text,v.appendChild(s)}}function a(){return f.value}function o(){for(var e=0;e<=CONFIG.grid_width;e++)for(var t=0;t<=CONFIG.grid_height;t++){var s=document.createElement("div");if(s.classList.add("grid_square"),s.style.top=t*CONFIG.grid_size+"px",s.style.left=e*CONFIG.grid_size+"px",s.style.width=CONFIG.grid_size+"px",s.style.height=CONFIG.grid_size+"px",m.appendChild(s),e<CONFIG.grid_width&&t<CONFIG.grid_height){var n=document.createElement("div"),a="grid_"+(e+1)+"_"+(t+1);n.id=a,n.classList.add("grid_button"),n.style.top=t*CONFIG.grid_size+CONFIG.grid_size/2+"px",n.style.left=e*CONFIG.grid_size+CONFIG.grid_size/2+"px",n.style.width=CONFIG.grid_size+"px",n.style.height=CONFIG.grid_size+"px",y.appendChild(n),input.add_button(a)}}}function r(e,t){d&&d.classList.remove("selected"),d=document.getElementById("grid_"+e+"_"+t),d.classList.add("selected")}function i(){return document.getElementById("charge_setter").value}function l(e){for(var t=0;t<x.length;t++)document.getElementById("path_"+x[t]).disabled=e.indexOf(x[t])==-1}function _(e){for(var t=0;t<x.length;t++)document.getElementById("gpath_"+x[t]).disabled=e.indexOf(x[t])==-1}function h(e){for(var t=0;t<b.length;t++)document.getElementById("add_"+b[t]).disabled=e.indexOf(b[t])==-1}function g(e,t){var s=document.getElementById("level_editor_context_config");s.getElementsByTagName("p")[0].innerHTML="Processor",list=s.getElementsByTagName("ul")[0],list.innerHTML="";for(var n=0;n<t.length;n++){var a=document.createElement("input");a.type="checkbox",a.checked=e[1].indexOf(n)!=-1,a.value=n,a.addEventListener("change",function(){level_editor.path_checkbox_changed(this)});var o=document.createElement("li");o.appendChild(a),o.appendChild(document.createTextNode("path_"+n)),list.appendChild(o)}}function c(e,t){w.innerHTML="";for(var s,n=t[e[e.length-1]],a=["n","e","s","w"],o=0;o<a.length;o++)if(s=n[a[o]]){if(1==e.length){var r=document.createElement("button");r.id="move_to_"+s[0],r.innerHTML="Move to "+a[o],r.addEventListener("click",function(){level_editor.move_patrol_to(this)}),w.appendChild(r)}var r=document.createElement("button");r.id="route_to_"+s[0],r.innerHTML="Route to "+a[o],r.addEventListener("click",function(){level_editor.add_route_to(this)}),w.appendChild(r)}if(e.length>1)for(o=0;o<a.length;o++)if(t[e[e.length-1]][a[o]]&&t[e[e.length-1]][a[o]][0]==e[0]){var i=document.createElement("button");i.innerHTML="Complete Route",i.addEventListener("click",function(){level_editor.route_complete()}),w.appendChild(i)}}function p(e){export_text.innerHTML=utils.stringify_level(e)}for(var d,u={start_screen:document.getElementById("start_screen"),select_level:document.getElementById("select_level"),play_game:document.getElementById("play_game"),game_complete:document.getElementById("game_complete"),custom_level:document.getElementById("custom_level"),level_editor:document.getElementById("level_editor"),export_text:document.getElementById("export_text"),game_background:document.getElementById("game_background")},v=document.getElementById("play_tips"),f=document.getElementById("custom_level_textarea"),m=document.getElementById("grid_bg"),y=document.getElementById("grid"),x=["n","ne","e","se","s","sw","w","nw"],b=["spot","objective","charge","gate_generator","gate","patrol_generator","patrol"],w=document.getElementById("level_editor_patrol_config"),O=0,C=0,N=1;N<=Object.keys(CONTENT.levels).length;N++){var T=document.createElement("button");T.textContent="lv "+N,T.id="level_"+N,T.classList.add("level_btn"),T.classList.add("left_"+O),T.classList.add("top_"+C),T.disabled=!0,O++,O==CONFIG.level_button_width&&(O=0,C++),u.select_level.appendChild(T),input.add_button("level_"+N)}o(),this.close_screen=e,this.open_screen=t,this.unlock_levels=s,this.place_game_tips=n,this.get_custom_level_input=a,this.select_grid_square=r,this.get_charge_count=i,this.enable_paths=l,this.enable_gpaths=_,this.enable_buttons=h,this.build_objective_config=g,this.build_patrol_config=c,this.export_level=p},game;window.onload=function(e){game=new Game};var Game=function(){function e(e){level_ready&&t.update(e)}var t=new GameMaster;level_editor=new LevelEditor,graphics=new Graphics,input=new Input,dom_manager=new DomManager,input.set_up_button_events(),t.inject_graphics(graphics),t.inject_input(input),t.inject_dom_manager(dom_manager),t.inject_level_editor(level_editor),level_editor.inject_game_master(t),level_editor.inject_input(input),level_editor.inject_dom_manager(dom_manager);var s=function(){var t=1e3/CONFIG.fps;next_tick=last_tick=(new Date).getTime();return num_frames=0,function(){for(current_tick=(new Date).getTime();current_tick>next_tick;)delta=(current_tick-last_tick)/1e3,e(delta),next_tick+=t,last_tick=(new Date).getTime();graphics.draw(),num_frames++}}();window.requestAnimationFrame?window.each_frame=function(e){var t=function(){e(),requestAnimationFrame(t)};t()}:window.mozRequestAnimationFrame?window.each_frame=function(e){var t=function(){e(),mozRequestAnimationFrame(t)};t()}:window.each_frame=function(e){setInterval(e,1e3/CONFIG.fps)},window.each_frame(s)},level_ready=!1,game_paused=!1,level_editor_mode=!0,GameMaster=function(){function update(e){game_paused||(avatar_manager.update(e),level_manager.update(e))}function inject_graphics(e){graphics=e,graphics.inject_avatar(avatar_manager.get_avatar()),level_manager.inject_graphics(e)}function inject_input(e){input=e,avatar_manager.inject_input(e),input.add_subscriber(this)}function inject_dom_manager(e){dom_manager=e}function inject_level_editor(e){level_editor=e}function start_game(){current_level=6,start_level()}function start_level(){level_manager.clear_level(),graphics.clear_level(),level_manager.setup_level(current_level),dom_manager.place_game_tips(level_manager.get_play_tips()),avatar_manager.start_level(),level_ready=!0}function level_complete(){setTimeout(function(){level_ready=!1,current_level++,current_level>highest_level&&(highest_level=current_level,dom_manager.unlock_levels(highest_level),document.cookie="omega_glitch_level="+highest_level),start_level()},1e3)}function game_complete(){dom_manager.open_screen("game_complete")}function reset_level(){level_ready=!1,start_level()}function button_pressed(button){"campaign"==button?(dom_manager.close_screen("start_screen"),dom_manager.open_screen("select_level"),dom_manager.unlock_levels(highest_level)):"level_editor_back"==button?(dom_manager.close_screen("level_editor"),level_editor_mode=!1,dom_manager.open_screen("start_screen")):"select_level_back"==button?(dom_manager.close_screen("select_level"),dom_manager.open_screen("start_screen")):"level_"==button.substring(0,6)?(current_level=parseInt(button.substring(6)),start_level(),dom_manager.close_screen("select_level"),dom_manager.open_screen("game_background"),dom_manager.open_screen("play_game")):"restart_level"==button?(level_ready=!1,start_level()):"quit_level"==button?(testing_level?(dom_manager.open_screen("level_editor"),level_editor_mode=!0):dom_manager.open_screen("select_level"),dom_manager.close_screen("game_background"),dom_manager.close_screen("play_game")):"back_to_start"==button?(dom_manager.close_screen("game_complete"),dom_manager.open_screen("start_screen")):"custom"==button?(dom_manager.close_screen("start_screen"),dom_manager.open_screen("custom_level")):"play_custom"==button?(set_up_custom_level(eval(dom_manager.get_custom_level_input())),dom_manager.close_screen("custom_level")):"build"==button&&(dom_manager.close_screen("start_screen"),dom_manager.open_screen("level_editor"),level_editor_mode=!0)}function read_in_cookie(){var e=document.cookie;e=e.split(";");for(var t=0;t<e.length;t++)if("omega_glitch_level="==e[t].trim().substring(0,19))return parseInt(e[t].substring(20))}function set_up_custom_level(e,t){CONTENT.levels[0]=e,current_level=0,testing_level=!!t,start_level()}var graphics,input,dom_manager,level_editor,current_level,testing_level,highest_level=read_in_cookie()||Object.keys(CONTENT.levels).length,avatar_manager=new AvatarManager;level_manager=new LevelManager,avatar_manager.inject_level_manager(level_manager),level_manager.inject_avatar_manager(avatar_manager),level_manager.inject_game_master(this),this.update=update,this.inject_graphics=inject_graphics,this.inject_input=inject_input,this.inject_dom_manager=inject_dom_manager,this.inject_level_editor=inject_level_editor,this.key_pressed=function(){},this.button_pressed=button_pressed,this.start_game=start_game,this.level_complete=level_complete,this.reset_level=reset_level,this.game_complete=game_complete,this.set_up_custom_level=set_up_custom_level},GAME_TEXT={lv1a:'This is you: a malicious little Glitch.  Use "A", "S", "W", "D" to move.',lv1b:'This is your objective: A system Processor.  Use "Space Bar" to detonate your malware charge to disable it.',lv2a:"Some paths are one way.  Restart the level if you get stuck.",lv2b:"Sometimes you may happen across a malware package from a fallen comrade.  Carry on his work!",lv3a:"Security Routines will stop you in your path.  Be careful.",lv4a:"Firewalls will prevent you from proceeding, though otherwise harmless.",lv4b:"Firewalls are powered from these Generators.  Detonate your malware on them to disable the generator along with their Firewalls.",lv5a:"Security Routines are also powered by their own Generators.  You know what to do...",lv6a:"Some systems take a bit more payload to take down.",lv6b:"You are on your own from here on."},Gate=function(e){function t(){active=!1}function s(){return active}this.pos_x=e.x*CONFIG.grid_size,this.pos_y=e.y*CONFIG.grid_size,this.size=10,this.collision=8,active=!0,this.blow_up=t,this.is_active=s,this.graphic={lineWidth:1,fillStyle:"rgba(204, 51, 51, 0.6)",shadowColor:"#6FC3DF",shadowBlur:5,shadowOffsetX:0,shadowOffsetY:0}},GateGenerator=function(e,t){function s(e){a=e,a.add_to_manifest(this,"gate_generators");for(var t=0;t<o.length;t++)o[t].inject_graphics(a),o[t].set_starting_spot(this.spot)}function n(){for(var e=0;e<o.length;e++)o[e].blow_up()}var a;this.spot=t[e.s],this.gates=e.g;var o=e.gp.slice(0);this.pos_x=this.spot.pos_x,this.pos_y=this.spot.pos_y,this.size=10;for(var r=0;r<o.length;r++)o[r]=new GateGeneratorPath(o[r]);this.blow_up=n,this.inject_graphics=s,this.graphic={lineWidth:1,fillStyle:"rgba(204, 104, 51, 0.6)",shadowColor:"#6FC3DF",shadowBlur:5,shadowOffsetX:0,shadowOffsetY:0}},GateGeneratorPath=function(e){function t(e){o=e,this.checkpoints=n(),graphics.add_to_manifest(this,"gate_generator_paths")}function s(e){graphics=e}function n(){r=[],r.push({x:o.pos_x,y:o.pos_y});for(var e,t,s=0;s<i.length;s+=2)e=i[s],t=i[s+1],r.push({x:CONFIG.direction_to_grid_difference[e].x*CONFIG.grid_size*t+r[r.length-1].x,y:CONFIG.direction_to_grid_difference[e].y*CONFIG.grid_size*t+r[r.length-1].y});return r}function a(){graphics.remove_from_manifest(this,"gate_generator_paths"),this.blown_up=!0}var o,r,i=e;this.checkpoints=[],this.graphic={setLineDash:[5,3],lineWidth:2,strokeStyle:"#ff5c33",shadowColor:"#6FC3DF",shadowBlur:5,shadowOffsetX:0,shadowOffsetY:0},this.set_starting_spot=t,this.inject_graphics=s,this.checkpoints=r,this.blow_up=a},Graphics=function(){function e(){p.clearRect(0,0,d,u);for(var e=0;e<v.length;e++)o(v[e]);p.font="bold 20px sans-serif",p.fillStyle="rgba(210,210,210,0.5)",p.fillText("Charges:"+h.charges,33,27)}function t(e){h=e}function s(){for(var e in g)g[e]=[];g.avatar=[h]}function n(e,t){var s=g[t];s.indexOf(e)==-1&&s.push(e)}function a(e,t){var s=g[t];s.indexOf(e)!=-1&&s.splice(s.indexOf(e),1)}function o(e){for(var t=g[e],s=0;s<t.length;s++){p.save();var n=t[s].graphic;for(var a in n)"setLineDash"!=a?p[a]=n[a]:p.setLineDash(n[a]);f[e](t[s]),p.restore()}}function r(e){p.beginPath(),p.arc(e.pos_x,e.pos_y,e.collision,0,2*Math.PI,!0),p.fill(),p.stroke(),e.charge&&_(e)}function i(e){var t=e.pos_x,s=e.pos_y,n=e.size;p.beginPath(),p.moveTo(t-n,s-n),p.lineTo(t+n,s-n),p.lineTo(t+n,s+n),p.lineTo(t-n,s+n),p.lineTo(t-n,s-n),p.fill(),p.stroke()}function l(e){p.beginPath();var t=e.checkpoints;p.moveTo(t[0].x,t[0].y);for(var s=1;s<t.length;s++)p.lineTo(t[s].x,t[s].y);p.stroke()}function _(e){p.fillStyle="rgba(212, 17, 27, 0.6)",p.shadowColor="#d0161e",p.shadowBlur=10,p.shadowOffsetX=0,p.shadowOffsetY=0,p.beginPath(),p.arc(e.pos_x,e.pos_y,4,0,2*Math.PI,!0),p.fill()}var h,g={spots:[],paths:[],objectives:[],patrols:[],patrol_generators:[],gates:[],gate_generators:[],gate_generator_paths:[],avatar:[]},c=document.getElementById(CONFIG.canvas_id),p=c.getContext("2d"),d=c.width,u=c.height,v=["paths","spots","objectives","patrols","patrol_generators","gates","gate_generators","gate_generator_paths","avatar"],f={paths:l,spots:r,objectives:i,patrols:r,patrol_generators:i,gates:i,gate_generators:i,gate_generator_paths:l,avatar:r};this.draw=e,this.clear_level=s,this.inject_avatar=t,this.add_to_manifest=n,this.remove_from_manifest=a};!function(){function e(e,t,s,n){d.beginPath(),d.moveTo(e,t),d.lineTo(s,n),d.closePath(),d.stroke()}function t(){this.points=[{y:Math.floor(Math.random()*u+1)*l,x:Math.floor(Math.random()*v+1)*l}],this.draw=n,this.move=s,this.dir=Math.floor(8*Math.random()+1)}function s(){var e=Math.floor(3*Math.random()-1),t=this.dir+e;t<0&&(t=7),7<t&&(t=0);var s=this.points[this.points.length-1];s.x<10&&(t=2),s.y<10&&(t=4),r.width-10<s.x&&(t=6),r.height-10<s.y&&(t=0),this.dir=t;var n={x:s.x+x[t].x*l,y:s.y+x[t].y*l};this.points.push(n),10<this.points.length&&this.points.shift()}function n(){var e=this.points;for(m=1;m<e.length;m++)i.beginPath(),i.moveTo(e[m-1].x,e[m-1].y),i.lineTo(e[m].x,e[m].y),i.closePath(),i.lineWidth=1,i.strokeStyle=g,i.stroke(),i.lineWidth=10,i.strokeStyle=c,i.stroke()}function a(e){this.snakeys=[];for(var s=0;s<e;s++)this.snakeys.push(new t);this.go=o}function o(){for(var e=0;e<this.snakeys.length;e++)this.snakeys[e].move(),this.snakeys[e].draw()}var r=document.getElementById("game_background");r.width=window.innerWidth,r.height=window.innerHeight;var i=r.getContext("2d");i.translate(.5,.5);var l=12,_="rgba(240,240,240)",h="rgba(0,20,40,0.9)",g="rgba(0,255,255,0.1)",c="rgba(0,100,100,0.1)",p=document.createElement("canvas");p.width=window.innerWidth,p.height=window.innerHeight;var d=p.getContext("2d");d.translate(.5,.5),d.fillStyle=_,d.fillRect(0,0,p.width,p.height);var u=Math.ceil(p.height/l),v=Math.ceil(p.width/l);d.strokeStyle=h;for(var f=1;f<=v;f++)e(f*l,0,f*l,p.height);for(var y=0;y<=u;y++)e(0,y*l,p.width,y*l);for(var y=0;y<=u+v;y++)e(0,y*l-p.width,p.width,y*l),e(0,y*l,p.width,y*l-p.width);var x=[{name:"up",x:0,y:-1},{name:"upright",x:1,y:-1},{name:"right",x:1,y:0},{name:"downright",x:1,y:1},{name:"down",x:0,y:1},{name:"downleft",x:-1,y:1},{name:"left",x:-1,y:0},{name:"upleft",x:-1,y:-1}],b=new a(10);i.drawImage(p,0,0),setInterval(function(){i.globalAlpha=.2,i.drawImage(p,0,0),i.globalAlpha=1,b.go()},1e3/30)}();var Input=function(){function e(e){o.push(e)}function t(){for(var e=0;e<o.length;e++){var t=document.getElementById(o[e]);!function(e){t.addEventListener("mouseup",function(){for(var t=0;t<a.length;t++)a[t].button_pressed(o[e])})}(e)}}function s(e){a.indexOf(e)===-1&&a.push(e)}function n(e){a.indexOf(e)!==-1&&e.splice(a.indexOf(e),1)}var a=[],o=["campaign","select_level_back","level_editor_back","custom","build","restart_level","quit_level","back_to_start","play_custom","add_spot","add_objective","add_charge","add_gate_generator","add_gate","add_patrol_generator","add_patrol","export","test_level","path_n","path_ne","path_e","path_se","path_s","path_sw","path_w","path_nw","gpath_n","gpath_ne","gpath_e","gpath_se","gpath_s","gpath_sw","gpath_w","gpath_nw"];window.addEventListener("keydown",function(e){for(var t=0;t<a.length;t++)a[t].key_pressed(e.key)}),this.add_subscriber=s,this.remove_subscriber=n,this.set_up_button_events=t,this.add_button=e},LevelEditor=function(){function e(e){O=e}function t(e){C=e,C.add_subscriber(this)}function n(e){N=e,N.enable_paths([]),N.enable_gpaths([]),N.enable_buttons(["spot"])}function a(e){if("grid_"==e.substring(0,5)){if(z||P||D)return;B=parseInt(e.split("_")[1]),M=parseInt(e.split("_")[2]),N.select_grid_square(B,M),o()}else if("add_spot"==e)l();else if("add_objective"==e)_();else if("add_charge"==e)h();else if("add_gate_generator"==e)g();else if("add_gate"==e)c();else if("add_patrol_generator"==e)p();else if("add_patrol"==e)d();else if("path_"==e.substring(0,5))u(I[e.split("_")[1]]);else if("gpath_"==e.substring(0,6))v(I[e.split("_")[1]]);else if("export"==e)N.export_level(F);else{if("test_level"!=e)return;N.close_screen("level_editor"),N.open_screen("game_background"),N.open_screen("play_game"),O.set_up_custom_level(F,!0)}}function o(){w(),T=r(),i()}function r(){response={};for(var e in F.spots)if(F.spots[e].x==B&&F.spots[e].y==M){response.spot=F.spots[e],response.spot_name=e,z&&(f(response.spot),S=[]);for(var t=0;t<F.objectives.length;t++)F.objectives[t][0]==e&&(response.objective=F.objectives[t],N.build_objective_config(response.objective,F.paths));for(var s=0;s<F.gate_generators.length;s++)F.gate_generators[s].s==e&&(response.gate_generator=F.gate_generators[s],k=F.gate_generators[s]);for(var n=0;n<F.patrol_generators.length;n++)F.patrol_generators[n].s==e&&(response.patrol_generator=F.patrol_generators[n],j=F.patrol_generators[n])}for(var a=0;a<F.gates.length;a++)F.gates[a].x==B&&F.gates[a].y==M&&(response.gate=F.gates[a]);return response}function i(){if(!T.spot||P||D)if(z){var e=["n","ne","e","se","s","sw","w","nw"],t=S[S.length-2]-1;t=(t+4)%8,e.splice(t,1),N.enable_paths(e),T.gate?N.enable_buttons([]):N.enable_buttons(["spot"]),N.enable_gpaths([])}else if(P){var e=["n","ne","e","se","s","sw","w","nw"],t=L[L.length-2]-1;t=(t+4)%8,e.splice(t,1),N.enable_gpaths(e),N.enable_paths([]),T.spot?N.enable_buttons([]):N.enable_buttons(["gate"])}else T.spot?(N.enable_paths([]),N.enable_gpaths([]),N.enable_buttons([])):(N.enable_paths([]),N.enable_gpaths([]),N.enable_buttons(["spot"]));else{for(var e=["n","e","s","w"],s=e.length-1;s>=0;s--)"undefined"!=typeof T.spot[e[s]]&&e.splice(s,1);N.enable_paths(e),T.objective||T.spot.charge||T.gate_generator||T.patrol_generator?(N.enable_buttons([]),T.gate_generator?N.enable_gpaths(["n","ne","e","se","s","sw","w","nw"]):T.patrol_generator&&N.enable_buttons("patrol")):N.enable_buttons(["objective","charge","gate_generator","patrol_generator"])}}function l(){W++;var e={x:B,y:M};F.spots["s"+W]=e,F.start||(F.start="s"+W),S.length&&f(e),z=!1,o()}function _(){var e=[T.spot_name,[]];F.objectives.push(e),o()}function h(){T.spot.charge=!0,o()}function g(){var e={s:T.spot_name,g:[],gp:[]};F.gate_generators.push(e),o()}function c(){var e={x:B,y:M};F.gates.push(e),k.g.push(F.gates.length-1),L=[],P=!1,o()}function p(){var e={s:T.spot_name,p:[]};F.patrol_generators.push(e),o()}function d(){var e=[j.s];E=e,F.patrols.push(e),j.p.push(F.patrols.length-1),D=!0,o(),N.build_patrol_config(e,F.spots)}function u(e){S.length?S[S.length-2]==e?S[S.length-1]++:S.push(e,1):(S.push(T.spot_name,e,1),F.paths.push(S),T.spot[G[e-1]]=F.paths.length-1),B+=CONFIG.direction_to_grid_difference[e].x,M+=CONFIG.direction_to_grid_difference[e].y,N.select_grid_square(B,M),z=!0,o()}function v(e){L.length||k.gp.push(L),L[L.length-2]==e?L[L.length-1]++:L.push(e,1),B+=CONFIG.direction_to_grid_difference[e].x,M+=CONFIG.direction_to_grid_difference[e].y,N.select_grid_square(B,M),P=!0,o()}function f(e){var t=[1,3,5,7],n=t.indexOf(S[S.length-2]),a=F.spots[S[0]],o=G[S[1]-1];for(s in F.spots)if(F.spots[s]==e){a[o]=[s,F.paths.length-1];break}n>-1&&(n=(n+2)%4,e[G[t[n]-1]]=[S[0],F.paths.length-1]),S=[],z=!1}function m(e){var t=parseInt(e.value),s=T.objective[1];e.checked?s.push(t):s.splice(s.indexOf(t),1)}function y(e){var t=e.id.split("_")[2];E[0]=t,o(),N.build_patrol_config(E,F.spots)}function x(e){var t=e.id.split("_")[2];E.push(t),o(),N.build_patrol_config(E,F.spots)}function b(){j=!1,E=!1,D=!1,o()}function w(){Object.keys(F.spots).length&&(F.charges=parseInt(N.get_charge_count())||0,O.set_up_custom_level(F))}var O,C,N,T,k,j,E,I={n:1,ne:2,e:3,se:4,s:5,sw:6,w:7,nw:8},G=["n","ne","e","se","s","sw","w","nw"],F={charges:0,spots:{},paths:[],patrols:[],patrol_generators:[],start:!1,objectives:[],gates:[],gate_generators:[]},B=0,M=0,S=[],L=[],z=!1,P=!1,D=!1,W=0;this.inject_game_master=e,this.inject_input=t,this.inject_dom_manager=n,this.key_pressed=function(){},this.button_pressed=a,this.path_checkbox_changed=m,this.move_patrol_to=y,this.add_route_to=x,this.route_complete=b,this.get_level=function(){return F}},LevelManager=function(){function e(e){h=CONTENT.levels[String(e)],c.set_avatar_charges(h.charges);for(var t in h.spots){var s=new Spot(h.spots[t]);d[t]=s,g.add_to_manifest(s,"spots")}for(this.starting_spot=d[h.start],i=0;i<h.paths.length;i++){var n=new Path(h.paths[i]);n.inject_graphics(g),n.set_starting_spot(d[h.paths[i][0]]),u.push(n)}for(i=0;i<h.objectives.length;i++){var a=new Objective(h.objectives[i],d);g.add_to_manifest(a,"objectives"),v.push(a)}for(i=0;i<h.patrols.length;i++){var o=new Patrol(h.patrols[i]);o.make_path_list(u,d),o.inject_graphics(g),f.push(o)}for(i=0;i<h.patrol_generators.length;i++){var r=new PatrolGenerator(h.patrol_generators[i],d);g.add_to_manifest(r,"patrol_generators"),m.push(r)}for(i=0;i<h.gates.length;i++){var l=new Gate(h.gates[i]);g.add_to_manifest(l,"gates"),y.push(l)}for(i=0;i<h.gate_generators.length;i++){var _=new GateGenerator(h.gate_generators[i],d);_.inject_graphics(g),x.push(_)}if(h.tips)for(i=0;i<h.tips.length;i++)b.push(new PlayTip(h.tips[i]))}function t(e,t){if(!e[t])return!1;var s={spot:d[e[t][0]],path:u[e[t][1]]};return!s.path.blocked&&s}function s(e){g=e}function n(e){c=e}function a(e){p=e}function o(e){for(var t=0;t<v.length;t++)if(v[t].spot==e){v[t].blow_up(),g.remove_from_manifest(v[t],"objectives");for(var s=v[t].paths.length-1;s>-1;s--){u[v[t].paths[s]].blow_up();for(var n=0;n<f.length;n++)f[n].get_current_path()===u[v[t].paths[s]]&&f[n].blow_up()}v.splice(t,1),v.length||(h.end_of_game?p.game_complete():p.level_complete())}for(t=0;t<m.length;t++)if(m[t].spot==e){m[t].blow_up();for(var n=m[t].patrols.length-1;n>-1;n--)f[m[t].patrols[n]].blow_up(),g.remove_from_manifest(f[m[t].patrols[n]].get_unit(),"patrols");g.remove_from_manifest(m[t],"patrol_generators")}for(t=0;t<x.length;t++)if(x[t].spot==e){x[t].blow_up();for(var a=x[t].gates.length-1;a>-1;a--)y[x[t].gates[a]].blow_up(),g.remove_from_manifest(y[x[t].gates[a]],"gates"),g.remove_from_manifest(x[t],"gate_generators")}}function r(){return b}function l(){d={},u=[],v=[],f=[],m=[],y=[],x=[],b=[]}function _(e){for(var t=0;t<f.length;t++)f[t].update(e),f[t].is_active()&&utils.check_collision(f[t].get_unit(),c.get_avatar())&&p.reset_level();for(t=0;t<y.length;t++)y[t].is_active()&&!c.get_gate_hit()&&utils.check_collision(y[t],c.get_avatar())&&c.hit_gate()}var h,g,c,p,d,u,v,f,m,y,x,b;this.starting_spot,this.setup_level=e,this.inject_graphics=s,this.inject_avatar_manager=n,this.inject_game_master=a,this.get_play_tips=r,this.move_leads_to=t,this.detonate_charge=o,this.clear_level=l,this.update=_},Objective=function(e,t){function s(){}this.spot=t[e[0]],this.paths=e[1],this.size=15,this.pos_x=this.spot.pos_x,this.pos_y=this.spot.pos_y,this.graphic={lineWidth:1,fillStyle:"rgba(250,247,91,0.2)",shadowColor:"#6FC3DF",shadowBlur:5,shadowOffsetX:0,shadowOffsetY:0},this.blow_up=s},Path=function(e){function t(e){r=e,this.checkpoints=n(),o.add_to_manifest(this,"paths")}function s(e){o=e}function n(){i=[],i.push({x:r.pos_x,y:r.pos_y});for(var t,s,n=1;n<e.length;n+=2)t=e[n],s=e[n+1],i.push({x:CONFIG.direction_to_grid_difference[t].x*CONFIG.grid_size*s+i[i.length-1].x,y:CONFIG.direction_to_grid_difference[t].y*CONFIG.grid_size*s+i[i.length-1].y});return i}function a(){this.blocked=!0,this.blown_up=!0,this.graphic.strokeStyle="rgba(209, 243, 248, 0.25)",this.graphic.shadowBlur=0}var o,r,i;this.graphic={lineWidth:2,strokeStyle:"rgba(209, 243, 248, 1)",shadowColor:"#6FC3DF",shadowBlur:5,shadowOffsetX:0,shadowOffsetY:0},this.set_starting_spot=t,this.inject_graphics=s,this.checkpoints=i,this.blow_up=a},Patrol=function(e){function t(e){p=e,p.add_to_manifest(w,"patrols")}function s(e,t){d=[];for(var s=0;s<b.length;s++)d.push(e[n(t[b[s]],b[(s+1)%b.length])]);w.pos_x=t[b[0]].pos_x,w.pos_y=t[b[0]].pos_y,y=w.pos_x,x=w.pos_y,v=-1,f=1,i()}function n(e,t){for(var s=0;s<C.length;s++)if(e[C[s]]&&e[C[s]][0]==t)return e[C[s]][1]}function a(e){O&&o(e)}function o(e){w.pos_x+=w.vol_x*e,w.pos_y+=w.vol_y*e,w.vol_x>0&&w.pos_x>u[m].x?r():w.vol_x<0&&w.pos_x<u[m].x&&r(),w.vol_y>0&&w.pos_y>u[m].y?r():w.vol_y<0&&w.pos_y<u[m].y&&r()}function r(){w.pos_x=u[m].x,w.pos_y=u[m].y,m++,m>=u.length?i():l()}function i(){if(!(b.length<2)){if(v=(v+f+b.length)%b.length,u=d[v],!u&&level_editor_mode)return v=-1,w.pos_x=y,w.pos_y=x,void i();u.blown_up&&(f=-f,v=(v+2*f+b.length)%b.length,u=d[v]),u=u.checkpoints.slice(0),u[0].x===w.pos_x&&u[0].y===w.pos_y||u.reverse(),m=1,l()}}function l(){var e=utils.normalize(w.pos_x,w.pos_y,u[m].x,u[m].y);w.vol_x=e[0]*w.speed,w.vol_y=e[1]*w.speed}function _(){return w}function h(){return O}function g(){O=!1}function c(){return d[v]}var p,d,u,v,f,m,y,x,b=e,w={pos_x:0,pos_y:0,vol_x:0,vol_y:0,speed:75,collision:10,graphic:{lineWidth:0,fillStyle:"rgba(207, 19, 28, 0.8)",shadowColor:"#6FC3DF",shadowBlur:20,shadowOffsetX:0,shadowOffsetY:0}},O=!0,C=["north","east","west","south"];this.make_path_list=s,this.update=a,this.inject_graphics=t,this.get_unit=_,this.get_current_path=c,this.blow_up=g,this.is_active=h},PatrolGenerator=function(e,t){function s(){}this.spot=t[e.s],this.patrols=e.p,this.pos_x=this.spot.pos_x,this.pos_y=this.spot.pos_y,this.size=10,this.blow_up=s,this.graphic={lineWidth:1,fillStyle:"rgba(84, 84, 51, 0.6)",shadowColor:"#6FC3DF",shadowBlur:5,shadowOffsetX:0,shadowOffsetY:0}},PlayTip=function(e){this.tip_text=GAME_TEXT[e.t],this.pos_x=e.x,this.pos_y=e.y},Spot=function(e){this.pos_x=e.x*CONFIG.grid_size,this.pos_y=e.y*CONFIG.grid_size,this.north=e.n,this.east=e.e,this.south=e.s,this.west=e.w,this.charge=e.charge||!1,this.collision=CONFIG.grid_size/2,this.graphic={fillStyle:"rgba(254, 254, 254, 0.8)",lineWidth:2,strokeStyle:"#29c8df",shadowColor:"#5ad4e6",shadowBlur:10,shadowOffsetX:0,shadowOffsetY:0}},Utils=function(){function e(e,t,s,n){x_dif=s-e,y_dif=n-t;var a=x_dif*x_dif+y_dif*y_dif;return a=Math.sqrt(a),[x_dif/a,y_dif/a]}function t(e,t){return s(e,t)<e.collision+t.collision}function s(e,t){var s=e.pos_x-t.pos_x,n=e.pos_y-t.pos_y;return Math.sqrt(s*s+n*n)}function n(e){var t=["n","e","s","w"],s="({charges:";s+=e.charges+",",s+="spots:{";for(var n in e.spots){var a=e.spots[n];s+=n+":{x:"+a.x+",y:"+a.y;for(var o=0;o<t.length;o++)"undefined"!=typeof a[t[o]]&&(s+=","+t[o]+":['"+a[t[o]][0]+"',"+a[t[o]][1]+"]");a.charge&&(s+=",charge:true"),s+="},"}s=s.substr(0,s.length-1),s+="},paths:[";for(var r=0;r<e.paths.length;r++)s+="['"+e.paths[r][0]+"',"+e.paths[r].slice(0).splice(1).toString()+"],";s=s.substr(0,s.length-1),s+="],patrols:[";for(var r=0;r<e.patrols.length;r++){s+="[";for(var i=0;i<e.patrols[r].length;i++)s+="'"+e.patrols[r][i]+"',";s=s.substr(0,s.length-1),s+="],"}","==s[s.length-1]&&(s=s.substr(0,s.length-1)),s+="],patrol_generators:[";for(var l=0;l<e.patrol_generators.length;l++)s+="{s:'"+e.patrol_generators[l].s+"',p:["+e.patrol_generators[l].p.slice(0).toString()+"]},";","==s[s.length-1]&&(s=s.substr(0,s.length-1)),s+="],start:'"+e.start+"',",s+="objectives:[";for(var _=0;_<e.objectives.length;_++)s+="['"+e.objectives[_][0]+"',["+e.objectives[_][1].toString()+"]],";","==s[s.length-1]&&(s=s.substr(0,s.length-1)),s+="],gates:[";for(var h=0;h<e.gates.length;h++)s+="{x:"+e.gates[h].x+",y:"+e.gates[h].y+"},";","==s[s.length-1]&&(s=s.substr(0,s.length-1)),s+="],gate_generators:[";for(var g=0;g<e.gate_generators.length;g++){s+="{s:'"+e.gate_generators[g].s+"',g:["+e.gate_generators[g].g.toString()+"],gp:[";for(var c=0;c<e.gate_generators[g].gp.length;c++)s+="["+e.gate_generators[g].gp[c].toString()+"],";","==s[s.length-1]&&(s=s.substr(0,s.length-1)),s+="]},"}return","==s[s.length-1]&&(s=s.substr(0,s.length-1)),s+="]});"}this.normalize=e,this.check_collision=t,this.stringify_level=n};utils=new Utils;var CONTENT=CONTENT||{levels:{}};CONTENT.levels[1]={charges:1,spots:{s1:{x:8,y:15,e:["s2",0]},s2:{x:20,y:15,w:["s1",0],e:["s3",1]},s3:{x:35,y:15,w:["s2",1]}},paths:[["s1",3,12],["s2",3,15]],patrols:[],patrol_generators:[],start:"s1",objectives:[["s3",[0,1]]],gates:[],gate_generators:[],tips:[{x:20,y:140,t:"lv1a"},{x:420,y:110,t:"lv1b"}]};var CONTENT=CONTENT||{levels:{}};CONTENT.levels[2]={charges:0,spots:{s1:{x:8,y:15,e:["s2",0]},s2:{x:20,y:15,w:["s1",0],e:["s3",1],n:["s4",2]},s3:{x:35,y:15,w:["s2",1],charge:!0},s4:{x:18,y:10}},paths:[["s1",3,12],["s2",3,15],["s2",1,3,8,2]],patrols:[],patrol_generators:[],start:"s1",objectives:[["s4",[0,1,2]]],gates:[],gate_generators:[],tips:[{x:140,y:60,t:"lv2a"},{x:420,y:120,t:"lv2b"}]};var CONTENT=CONTENT||{levels:{}};CONTENT.levels[3]={charges:1,spots:{s1:{x:8,y:15,e:["s2",0]},s2:{x:12,y:15,w:["s1",0],e:["s4",1],n:["s3",2]},s3:{x:12,y:10,s:["s2",2]},s4:{x:16,y:15,w:["s2",1],e:["s5",3]},s5:{x:20,y:15,w:["s4",3],e:["s6",4]},s6:{x:24,y:15,w:["s5",4],e:["s7",5],s:["s8",6]},s7:{x:30,y:11,s:["s6",5]},s8:{x:30,y:19,w:["s6",6]}},paths:[["s1",3,4],["s2",3,4],["s2",1,5],["s4",3,4],["s5",3,4],["s6",3,3,2,3,1,1],["s6",5,2,4,2,3,4]],start:"s1",objectives:[["s7",[0,1,2,3,4,5,6]]],patrols:[["s3","s2","s4","s5","s6","s8","s6","s5","s4","s2"]],patrol_generators:[{s:"s8",p:[0]}],gates:[],gate_generators:[],tips:[{x:130,y:260,t:"lv3a"}]};var CONTENT=CONTENT||{levels:{}};CONTENT.levels[4]={charges:2,spots:{s1:{x:9,y:7,s:["s2",0]},s2:{x:10,y:12,n:["s1",0],e:["s3",1]},s3:{x:14,y:12,w:["s2",1],e:["s4",2],n:["s7",5]},s4:{x:22,y:14,w:["s3",2],e:["s5",3],s:["s6",4]},s5:{x:25,y:11,s:["s4",3]},s6:{x:20,y:17,e:["s4",4]},s7:{x:20,y:8,w:["s3",5]}},paths:[["s1",5,2,4,1,5,2],["s2",3,4],["s3",3,2,4,2,3,4],["s4",3,2,2,1,1,2],["s4",5,2,6,1,7,1],["s3",1,2,2,2,3,4]],
start:"s1",objectives:[["s5",[0,1,2,3,4,5]]],patrols:[["s6","s4","s3","s4"]],patrol_generators:[{s:"s6",p:[0]}],gates:[{x:20,y:14,p:2}],gate_generators:[{s:"s7",g:[0],gp:[[5,6]]}],tips:[{x:50,y:230,t:"lv4a"},{x:330,y:40,t:"lv4b"}]};var CONTENT=CONTENT||{levels:{}};CONTENT.levels[5]={charges:1,spots:{s1:{x:8,y:20,n:["s2",0]},s2:{x:9,y:13,s:["s1",0],n:["s3",1],e:["s4",2]},s3:{x:6,y:12,n:["s2",1],charge:!0},s4:{x:16,y:15,w:["s2",2],s:["s5",3],e:["s7",6]},s5:{x:15,y:20,n:["s4",3],s:["s6",4]},s6:{x:22,y:20,w:["s5",4],n:["s7",5]},s7:{x:19,y:15,w:["s4",6],s:["s6",5],e:["s8",7]},s8:{x:23,y:10,s:["s7",7],w:["s9",8]},s9:{x:19,y:11,e:["s8",8]}},paths:[["s1",1,3,2,1,1,3],["s2",1,2,2,1,1,3,8,1,7,3,6,1,5,2,4,1,5,2],["s2",3,2,4,2,3,3],["s4",5,2,6,1,5,2],["s5",5,1,6,9,3,1,2,10,3,1,6,10,3,1,2,10,3,1,6,10,3,1,2,10,3,1],["s6",1,1,8,3,1,1],["s4",3,3],["s7",3,2,2,2,1,3],["s8",7,2,6,1,7,1]],start:"s1",objectives:[["s8",[0,1,2,3,4,5,6,7,8]]],patrols:[["s5","s4","s7","s6"]],patrol_generators:[{s:"s5",p:[0]}],gates:[{x:18,y:15,p:6}],gate_generators:[{s:"s9",g:[0],gp:[[5,1,6,1,5,2]]}],tips:[{x:280,y:360,t:"lv5a"}]};var CONTENT=CONTENT||{levels:{}};CONTENT.levels[6]={charges:4,spots:{s1:{x:28,y:18,n:["s2",0]},s2:{x:20,y:14,e:["s1",0],s:["s3",1]},s3:{x:8,y:18,n:["s2",1],w:["s4",2]},s4:{x:4,y:10,s:["s3",2],n:["s5",3],e:["s9",8]},s5:{x:9,y:4,w:["s4",3],e:["s6",4],n:["s10",9]},s6:{x:15,y:4,w:["s5",4],n:["s7",5]},s7:{x:22,y:1,w:["s6",5],s:["s8",6]},s8:{x:19,y:8,e:["s7",6],w:["s9",7]},s9:{x:14,y:9,e:["s8",7],w:["s4",8]},s10:{x:6,y:1,e:["s5",9]}},paths:[["s1",1,2,8,2,7,6],["s2",5,3,6,2,8,2,1,3,7,6,6,2,5,2],["s3",7,2,8,2,1,6],["s4",1,3,2,3,3,2],["s5",3,6],["s6",1,2,2,1,3,6],["s7",5,6,6,1,7,2],["s8",7,2,6,1,7,2],["s9",7,6,6,1,7,3],["s5",1,2,8,1,7,2]],start:"s1",objectives:[["s4",[0,1,2,3,8,7,6]],["s7",[5,4,9,3]]],patrols:[["s10","s5","s6","s7","s8","s9","s4","s5"],["s8","s9","s4","s5","s10","s5","s6","s7"]],patrol_generators:[{s:"s10",p:[0,1]}],gates:[{x:11,y:9,p:8}],gate_generators:[{s:"s9",g:[0],gp:[[6,1,7,1,8,1]]}],tips:[{x:120,y:-70,t:"lv6a"},{x:320,y:300,t:"lv6b"}],end_of_game:!0};var CONTENT=CONTENT||{levels:{}};CONTENT.levels[7]={charges:0,spots:{s1:{x:12,y:14,e:["s2",0]},s2:{x:19,y:14,n:["s5",3],e:["s3",1],w:["s1",0]},s3:{x:26,y:14,n:["s6",5],e:["s4",2],w:["s2",1]},s4:{x:32,y:14,n:["s7",6],w:["s3",2]},s5:{x:19,y:8,e:["s6",4],s:["s2",3]},s6:{x:25,y:8,s:["s3",5],w:["s5",4]},s7:{x:33,y:9,s:["s4",6],charge:!0}},paths:[["s1",3,7],["s2",3,7],["s3",3,6],["s2",1,6],["s5",3,6],["s6",5,2,4,1,5,3],["s4",1,2,2,1,1,2]],patrols:[["s4","s3","s2","s3"],["s6","s3","s2","s5"]],patrol_generators:[{s:"s4",p:[0,1]}],start:"s1",objectives:[["s6",[0,1,2,3,4,5]]],gates:[],gate_generators:[]},CONTENT.levels[8]={charges:0,spots:{s1:{x:5,y:22,n:["s2",0],w:["s4",2]},s2:{x:6,y:14,e:["s3",1],s:["s1",0],w:["s9",7]},s3:{x:14,y:16,e:["s10",8],w:["s2",1]},s4:{x:3,y:28,n:["s1",2],e:["s6",4]},s5:{x:14,y:24,e:["s10",10],w:["s1",3]},s6:{x:6,y:28,w:["s4",4],charge:!0},s7:{x:9,y:10,e:["s8",5],w:["s2",6],charge:!0},s8:{x:19,y:11,e:["s10",9],w:["s7",5]},s9:{x:2,y:10,s:["s2",7]},s10:{x:21,y:15,n:["s8",9],s:["s5",10],w:["s3",8]}},paths:[["s1",1,4,2,1,1,3],["s2",3,3,4,2,3,3],["s1",7,1,6,1,5,5],["s5",7,3,8,1,7,4,8,1],["s4",3,3],["s7",3,5,4,1,3,4],["s7",7,1,6,1,5,2,6,1],["s2",7,2,8,2,1,2],["s3",3,3,2,1,3,3],["s10",1,4,7,2],["s10",5,6,6,1,5,2,7,6]],patrols:[["s2","s3","s10","s8","s7"],["s10","s8","s7","s2","s3"]],patrol_generators:[{s:"s9",p:[0,1]}],start:"s1",objectives:[["s4",[0,1,2,3,4,5,6,7,8,9,10]]],gates:[{x:3,y:26}],gate_generators:[{s:"s5",g:[0],gp:[[6,2,7,9]]}]}}();