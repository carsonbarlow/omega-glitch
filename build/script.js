!function(){var e,t=function(){function e(){x.charges&&(x.charges--,u.detonate_charge(p))}function t(){var e=utils.normalize(x.pos_x,x.pos_y,v[d].x,v[d].y);x.vol_x=e[0]*x.speed,x.vol_y=e[1]*x.speed}function i(e){function i(){x.pos_x=v[d].x,x.pos_y=v[d].y,d++,d>=v.length?n(next_spot):t()}y&&(x.pos_x+=x.vol_x*e,x.pos_y+=x.vol_y*e,x.vol_x>0&&x.pos_x>v[d].x?i():x.vol_x<0&&x.pos_x<v[d].x&&i(),x.vol_y>0&&x.pos_y>v[d].y?i():x.vol_y<0&&x.pos_y<v[d].y&&i())}function n(e){p=e,y=!1,x.pos_x=e.x*s.grid_size,x.pos_y=e.y*s.grid_size,e.charge&&(x.charges++,e.charge=!1)}function a(){n(u.starting_spot)}function o(e){i(e)}function r(){return x}function c(e){f=e,f.add_subscriber(this)}function _(i){if(!y){if(" "===i)return void e();var s=u.move_leads_to(p,g[i]);s&&(v=s.path.checkpoints.slice(0),v[0].x===x.pos_x&&v[0].y===x.pos_y||v.reverse(),d=1,next_spot=s.spot,t(),y=!0)}}function l(e){u=e}function h(e){x.charges=e}var f,u,v,d,p,g={a:"west",s:"south",d:"east",w:"north"},x={pos_x:0,pos_y:0,vol_x:0,vol_y:0,speed:500,charges:0},y=!1;this.update=o,this.get_avatar=r,this.start_level=a,this.inject_input=c,this.key_pressed=_,this.inject_level_manager=l,this.set_avatar_charges=h},s={canvas_id:"game_canvas",fps:60,grid_size:15,FOREGROUND:1,BACKGROUND:0,direction_to_grid_difference:{1:{x:0,y:-1},2:{x:1,y:-1},3:{x:1,y:0},4:{x:1,y:1},5:{x:0,y:1},6:{x:-1,y:1},7:{x:-1,y:0},8:{x:-1,y:-1}}};window.onload=function(t){e=new n};var n=function(){function e(e){t.update(e)}var t=new a;graphics=new o,input=new r,t.inject_graphics(graphics),t.inject_input(input);var i=function(){var t=1e3/s.fps;next_tick=last_tick=(new Date).getTime();return num_frames=0,function(){for(current_tick=(new Date).getTime();current_tick>next_tick;)delta=(current_tick-last_tick)/1e3,e(delta),next_tick+=t,last_tick=(new Date).getTime();graphics.draw(),num_frames++}}();document.oncontextmenu=document.body.oncontextmenu=function(){return!1},window.requestAnimationFrame?window.each_frame=function(e){var t=function(){e(),requestAnimationFrame(t)};t()}:window.mozRequestAnimationFrame?window.each_frame=function(e){var t=function(){e(),mozRequestAnimationFrame(t)};t()}:window.each_frame=function(e){setInterval(e,1e3/s.fps)},window.each_frame(i),t.start_game()},a=function(){function e(e){h.update(e)}function i(e){r=e,r.inject_avatar(h.get_avatar()),level_manager.inject_graphics(e)}function s(e){_=e,h.inject_input(e)}function n(){l=3,a()}function a(){level_manager.clear_level(),level_manager.setup_level(l),h.start_level()}function o(){l++,a()}var r,_,l,h=new t;level_manager=new c,h.inject_level_manager(level_manager),level_manager.inject_avatar_manager(h),level_manager.inject_game_master(this),this.update=e,this.inject_graphics=i,this.inject_input=s,this.start_game=n,this.level_complete=o},o=function(){function e(){g.clearRect(0,0,w,j),_(),a(),u(),g.save(),g.lineWidth=0,g.fillStyle="rgba(95,232,232,0.7)",g.beginPath(),g.arc(d.pos_x,d.pos_y,10,0,2*Math.PI,!0),g.closePath(),g.fill(),g.restore()}function t(e){d=e}function i(){x=[],y=[],m=[]}function n(e){y.indexOf(e)===-1&&y.push(e)}function a(){g.save();for(var e=0;e<y.length;e++)o(y[e]);g.restore()}function o(e){g.strokeStyle="#cc3399",g.fillStyle="rgba(204, 51, 153, 0.8)",g.beginPath(),g.arc(e.x*s.grid_size,e.y*s.grid_size,s.grid_size,0,2*Math.PI,!0),g.closePath(),g.stroke(),g.fill(),e.charge&&r(e)}function r(e){g.strokeStyle="#8888DD",g.fillStyle="#8888DD",g.arc(e.x*s.grid_size,e.y*s.grid_size,4,0,2*Math.PI,!0),g.closePath(),g.stroke(),g.fill()}function c(e){x.indexOf(e)===-1&&x.push(e)}function _(){g.save(),g.lineWidth=7,g.strokeStyle="#33cc33";for(var e=0;e<x.length;e++)l(x[e]);g.restore()}function l(e){g.moveTo(e[0].x,e[0].y);for(var t=1;t<e.length;t++)g.lineTo(e[t].x,e[t].y);g.stroke()}function h(e){m.indexOf(e)===-1&&m.push(e)}function f(e){m.indexOf(e)!==-1&&m.splice(m.indexOf(e),1)}function u(){g.save(),g.lineWidth=1,g.strokeStyle="#000000",g.fillStyle="rgba(51, 204, 204, 0.8)";for(var e=0;e<m.length;e++)v(m[e]);g.restore()}function v(e){var t=e.spot.x*s.grid_size,i=e.spot.y*s.grid_size,n=20;g.moveTo(t-n,i-n),g.lineTo(t+n,i-n),g.lineTo(t+n,i+n),g.lineTo(t-n,i+n),g.lineTo(t-n,i-n),g.fill(),g.stroke()}var d,p=document.getElementById(s.canvas_id),g=p.getContext("2d"),x=[],y=[],m=[],w=p.width,j=p.height;this.draw=e,this.add_spot=n,this.add_path=c,this.clear_level=i,this.add_objective=h,this.remove_objective=f,this.inject_avatar=t},r=function(){function e(e){i.indexOf(e)===-1&&i.push(e)}function t(e){i.indexOf(e)!==-1&&e.splice(i.indexOf(e),1)}var i=[];window.addEventListener("keydown",function(e){for(var t=0;t<i.length;t++)i[t].key_pressed(e.key)}),this.add_subscriber=e,this.remove_subscriber=t},c=function(){function e(e){c=u.levels[String(e)],v.set_avatar_charges(c.charges);for(var t in c.spots){var s=new h(c.spots[t]);p[t]=s,f.add_spot(s)}for(this.starting_spot=p[c.start],i=0;i<c.paths.length;i++){var n=new l(c.paths[i]);n.inject_graphics(f),n.set_starting_spot(p[c.paths[i][0]]),g.push(n)}for(i=0;i<c.objectives.length;i++){var a=new _(p[c.objectives[i]]);f.add_objective(a),x.push(a)}}function t(e,t){return!!e[t]&&{spot:p[e[t][0]],path:g[e[t][1]]}}function s(e){f=e}function n(e){v=e}function a(e){d=e}function o(e){for(var t=0;t<x.length;t++)x[t].spot==e&&(x[t].blow_up(),f.remove_objective(x[t]),x.splice(t,1),x.length||d.level_complete())}function r(){f.clear_level(),p={},g=[],x=[]}var c,f,v,d,p,g,x;this.starting_spot,this.setup_level=e,this.inject_graphics=s,this.inject_avatar_manager=n,this.inject_game_master=a,this.move_leads_to=t,this.detonate_charge=o,this.clear_level=r},_=function(e){function t(){}this.spot=e,this.blow_up=t},l=function(e){function t(e){o=e,this.checkpoints=n(),a.add_path(r)}function i(e){a=e}function n(){r=[],r.push({x:o.x*s.grid_size,y:o.y*s.grid_size});for(var t,i,n=1;n<e.length;n+=2)t=e[n],i=e[n+1],r.push({x:s.direction_to_grid_difference[t].x*s.grid_size*i+r[r.length-1].x,y:s.direction_to_grid_difference[t].y*s.grid_size*i+r[r.length-1].y});return r}var a,o,r;this.set_starting_spot=t,this.inject_graphics=i,this.checkpoints=r},h=function(e){this.x=e.x,this.y=e.y,this.north=e.n,this.east=e.e,this.south=e.s,this.west=e.w,this.charge=e.charge||!1},f=function(){this.normalize=function(e,t,i,s){x_dif=i-e,y_dif=s-t;var n=x_dif*x_dif+y_dif*y_dif;return n=Math.sqrt(n),[x_dif/n,y_dif/n]}};utils=new f;var u=u||{levels:{}};u.levels[1]={charges:1,spots:{s1:{x:8,y:15,e:["s2",0]},s2:{x:20,y:15,w:[0,0],e:["s3",1]},s3:{x:35,y:15,w:["s2",1]}},paths:[["s1",3,12],["s2",3,15]],start:"s1",objectives:["s3"]};var u=u||{levels:{}};u.levels[2]={charges:0,spots:{s1:{x:8,y:15,e:["s2",0]},s2:{x:20,y:15,w:[0,0],e:["s3",1],n:["s4",2]},s3:{x:35,y:15,w:["s2",1],charge:!0},s4:{x:20,y:10,s:["s2",2]}},paths:[["s1",3,12],["s2",3,15],["s2",1,5]],start:"s1",objectives:["s4"]};var u=u||{levels:{}};u.levels[3]={charges:1,spots:{s1:{x:8,y:15,e:["s2",0]},s2:{x:12,y:15,w:["s1",0],e:["s4",1],n:["s3",2]},s3:{x:12,y:10,s:["s2",2]},s4:{x:16,y:15,w:["s2",1],e:["s5",3]},s5:{x:20,y:15,w:["s4",3],e:["s6",4]},s6:{x:24,y:15,w:["s5",4],e:["s7",5],s:["s8",6]},s7:{x:30,y:11,s:["s6",5]},s8:{x:30,y:19,w:["s6",6]}},paths:[["s1",3,4],["s2",3,4],["s2",1,5],["s4",3,4],["s5",3,4],["s6",3,3,2,3,1,1],["s6",5,2,4,2,3,4]],start:"s1",objectives:["s7"]}}();