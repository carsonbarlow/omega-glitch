!function(){var e,s=function(){function e(){x.charges&&(x.charges--,u.detonate_charge(v))}function s(){var e=utils.normalize(x.pos_x,x.pos_y,p[d].x,p[d].y);x.vol_x=e[0]*x.speed,x.vol_y=e[1]*x.speed}function i(e){function t(){x.pos_x=p[d].x,x.pos_y=p[d].y,d++,d>=p.length?n(next_spot):s()}y&&(x.pos_x+=x.vol_x*e,x.pos_y+=x.vol_y*e,x.vol_x>0&&x.pos_x>p[d].x?t():x.vol_x<0&&x.pos_x<p[d].x&&t(),x.vol_y>0&&x.pos_y>p[d].y?t():x.vol_y<0&&x.pos_y<p[d].y&&t())}function n(e){v=e,y=!1,x.pos_x=e.x*t.grid_size,x.pos_y=e.y*t.grid_size,e.charge&&(x.charges++,e.charge=!1)}function o(){n(u.starting_spot)}function a(e){i(e)}function r(){return x}function c(e){f=e,f.add_subscriber(this)}function l(t){if(!y){if(" "===t)return void e();var i=u.move_leads_to(v,g[t]);i&&(p=i.path.checkpoints.slice(0),p[0].x===x.pos_x&&p[0].y===x.pos_y||p.reverse(),d=1,next_spot=i.spot,s(),y=!0)}}function _(e){u=e}function h(e){x.charges=e}var f,u,p,d,v,g={a:"west",s:"south",d:"east",w:"north"},x={pos_x:0,pos_y:0,vol_x:0,vol_y:0,speed:500,charges:0,collision:10},y=!1;this.update=a,this.get_avatar=r,this.start_level=o,this.inject_input=c,this.key_pressed=l,this.inject_level_manager=_,this.set_avatar_charges=h},t={canvas_id:"game_canvas",fps:60,grid_size:15,FOREGROUND:1,BACKGROUND:0,direction_to_grid_difference:{1:{x:0,y:-1},2:{x:1,y:-1},3:{x:1,y:0},4:{x:1,y:1},5:{x:0,y:1},6:{x:-1,y:1},7:{x:-1,y:0},8:{x:-1,y:-1}}};window.onload=function(s){e=new n};var n=function(){function e(e){o&&s.update(e)}var s=new a;graphics=new r,input=new c,s.inject_graphics(graphics),s.inject_input(input);var i=function(){var s=1e3/t.fps;next_tick=last_tick=(new Date).getTime();return num_frames=0,function(){for(current_tick=(new Date).getTime();current_tick>next_tick;)delta=(current_tick-last_tick)/1e3,e(delta),next_tick+=s,last_tick=(new Date).getTime();graphics.draw(),num_frames++}}();window.requestAnimationFrame?window.each_frame=function(e){var s=function(){e(),requestAnimationFrame(s)};s()}:window.mozRequestAnimationFrame?window.each_frame=function(e){var s=function(){e(),mozRequestAnimationFrame(s)};s()}:window.each_frame=function(e){setInterval(e,1e3/t.fps)},window.each_frame(i),s.start_game()},o=!1,a=function(){function e(e){u.update(e),level_manager.update(e)}function t(e){_=e,_.inject_avatar(u.get_avatar()),level_manager.inject_graphics(e)}function i(e){h=e,u.inject_input(e)}function n(){f=1,a()}function a(){level_manager.clear_level(),level_manager.setup_level(f),u.start_level(),o=!0}function r(){o=!1,f++,a()}function c(){o=!1,a()}var _,h,f,u=new s;level_manager=new l,u.inject_level_manager(level_manager),level_manager.inject_avatar_manager(u),level_manager.inject_game_master(this),this.update=e,this.inject_graphics=t,this.inject_input=i,this.start_game=n,this.level_complete=r,this.reset_level=c},r=function(){function e(){m.clearRect(0,0,z,C),l(),o(),u(),g(),m.save(),m.lineWidth=0,m.fillStyle="rgba(250,247,91,0.7)",m.shadowColor="#39b5a6",m.shadowBlur=5,m.shadowOffsetX=0,m.shadowOffsetY=0,m.beginPath(),m.arc(y.pos_x,y.pos_y,5,0,2*Math.PI,!0),m.closePath(),m.fill(),m.restore()}function s(e){y=e}function i(){j=[],b=[],O=[],k=[]}function n(e){b.indexOf(e)===-1&&b.push(e)}function o(){m.save();for(var e=0;e<b.length;e++)a(b[e]);m.restore()}function a(e){m.fillStyle="rgba(254, 254, 254, 0.8)",m.lineWidth=2,m.strokeStyle="#29c8df",m.shadowColor="#5ad4e6",m.shadowBlur=10,m.shadowOffsetX=0,m.shadowOffsetY=0,m.beginPath(),m.arc(e.x*t.grid_size,e.y*t.grid_size,t.grid_size/2,0,2*Math.PI,!0),m.closePath(),m.fill(),m.stroke(),e.charge&&r(e)}function r(e){m.fillStyle="rgba(212, 17, 27, 0.6)",m.shadowColor="#d0161e",m.shadowBlur=10,m.shadowOffsetX=0,m.shadowOffsetY=0,m.arc(e.x*t.grid_size,e.y*t.grid_size,4,0,2*Math.PI,!0),m.closePath(),m.fill()}function c(e){j.indexOf(e)===-1&&j.push(e)}function l(){m.save(),m.lineWidth=2,m.strokeStyle="#d1f3f8",m.shadowColor="#6FC3DF",m.shadowBlur=5,m.shadowOffsetX=0,m.shadowOffsetY=0;for(var e=0;e<j.length;e++)_(j[e]);m.restore()}function _(e){m.moveTo(e[0].x,e[0].y);for(var s=1;s<e.length;s++)m.lineTo(e[s].x,e[s].y);m.stroke()}function h(e){O.indexOf(e)===-1&&O.push(e)}function f(e){O.indexOf(e)!==-1&&O.splice(O.indexOf(e),1)}function u(){m.save(),m.lineWidth=1,m.fillStyle="rgba(51, 204, 204, 0.2)",m.shadowColor="#6FC3DF",m.shadowBlur=5,m.shadowOffsetX=0,m.shadowOffsetY=0;for(var e=0;e<O.length;e++)p(O[e]);m.restore()}function p(e){var s=e.spot.x*t.grid_size,i=e.spot.y*t.grid_size,n=10;m.moveTo(s-n,i-n),m.lineTo(s+n,i-n),m.lineTo(s+n,i+n),m.lineTo(s-n,i+n),m.lineTo(s-n,i-n),m.fill()}function d(e){k.indexOf(e)===-1&&k.push(e)}function v(e){k.indexOf(e)!==-1&&k.splice(k.indexOf(e),1)}function g(){for(var e=0;e<k.length;e++)x(k[e])}function x(e){m.save(),m.lineWidth=0,m.fillStyle="#cf131c",m.shadowColor="#6FC3DF",m.shadowBlur=20,m.shadowOffsetX=0,m.shadowOffsetY=0,m.beginPath(),m.arc(e.pos_x,e.pos_y,10,0,2*Math.PI,!0),m.closePath(),m.fill(),m.restore()}var y,w=document.getElementById(t.canvas_id),m=w.getContext("2d"),j=[],b=[],O=[],k=[],z=w.width,C=w.height;this.draw=e,this.add_spot=n,this.add_path=c,this.clear_level=i,this.add_objective=h,this.remove_objective=f,this.inject_avatar=s,this.add_patrol=d,this.remove_patrol=v},c=function(){function e(e){t.indexOf(e)===-1&&t.push(e)}function s(e){t.indexOf(e)!==-1&&e.splice(t.indexOf(e),1)}var t=[];window.addEventListener("keydown",function(e){for(var s=0;s<t.length;s++)t[s].key_pressed(e.key)}),this.add_subscriber=e,this.remove_subscriber=s},l=function(){function e(e){l=d.levels[String(e)],v.set_avatar_charges(l.charges);for(var s in l.spots){var t=new u(l.spots[s]);x[s]=t,p.add_spot(t)}for(this.starting_spot=x[l.start],i=0;i<l.paths.length;i++){var n=new h(l.paths[i]);n.inject_graphics(p),n.set_starting_spot(x[l.paths[i][0]]),y.push(n)}for(i=0;i<l.objectives.length;i++){var o=new _(x[l.objectives[i]]);p.add_objective(o),w.push(o)}for(i=0;i<l.patrols.length;i++){var a=new f(l.patrols[i]);a.make_path_list(y,x),a.inject_graphics(p),m.push(a)}}function s(e,s){return!!e[s]&&{spot:x[e[s][0]],path:y[e[s][1]]}}function t(e){p=e}function n(e){v=e}function o(e){g=e}function a(e){for(var s=0;s<w.length;s++)w[s].spot==e&&(w[s].blow_up(),p.remove_objective(w[s]),w.splice(s,1),w.length||g.level_complete())}function r(){p.clear_level(),x={},y=[],w=[],m=[]}function c(e){for(var s=0;s<m.length;s++)m[s].update(e),utils.check_collision(m[s].get_unit(),v.get_avatar())&&g.reset_level()}var l,p,v,g,x,y,w,m;this.starting_spot,this.setup_level=e,this.inject_graphics=t,this.inject_avatar_manager=n,this.inject_game_master=o,this.move_leads_to=s,this.detonate_charge=a,this.clear_level=r,this.update=c},_=function(e){function s(){}this.spot=e,this.blow_up=s},h=function(e){function s(e){a=e,this.checkpoints=n(),o.add_path(r)}function i(e){o=e}function n(){r=[],r.push({x:a.x*t.grid_size,y:a.y*t.grid_size});for(var s,i,n=1;n<e.length;n+=2)s=e[n],i=e[n+1],r.push({x:t.direction_to_grid_difference[s].x*t.grid_size*i+r[r.length-1].x,y:t.direction_to_grid_difference[s].y*t.grid_size*i+r[r.length-1].y});return r}var o,a,r;this.set_starting_spot=s,this.inject_graphics=i,this.checkpoints=r},f=function(e){function s(e){_=e,_.add_patrol(g)}function i(e,s){h=[];for(var i=0;i<v.length;i++)h.push(e[n(s[v[i]],v[(i+1)%v.length])]);g.pos_x=s[v[0]].x*t.grid_size,g.pos_y=s[v[0]].y*t.grid_size,u=-1,p=1,r()}function n(e,s){for(var t=0;t<y.length;t++)if(e[y[t]]&&e[y[t]][0]==s)return e[y[t]][1]}function o(e){a(e)}function a(e){function s(){g.pos_x=f[d].x,g.pos_y=f[d].y,d++,d>=f.length?r():c()}x&&(g.pos_x+=g.vol_x*e,g.pos_y+=g.vol_y*e,g.vol_x>0&&g.pos_x>f[d].x?s():g.vol_x<0&&g.pos_x<f[d].x&&s(),g.vol_y>0&&g.pos_y>f[d].y?s():g.vol_y<0&&g.pos_y<f[d].y&&s())}function r(){u=(u+p+v.length)%v.length,f=h[u].checkpoints.slice(0),f[0].x===g.pos_x&&f[0].y===g.pos_y||f.reverse(),d=1,c()}function c(){var e=utils.normalize(g.pos_x,g.pos_y,f[d].x,f[d].y);g.vol_x=e[0]*g.speed,g.vol_y=e[1]*g.speed}function l(){return g}var _,h,f,u,p,d,v=e,g={pos_x:0,pos_y:0,vol_x:0,vol_y:0,speed:75,collision:10},x=!0,y=["north","east","west","south"];this.make_path_list=i,this.update=o,this.inject_graphics=s,this.get_unit=l},u=function(e){this.x=e.x,this.y=e.y,this.north=e.n,this.east=e.e,this.south=e.s,this.west=e.w,this.charge=e.charge||!1},p=function(){function e(e,s,t,i){x_dif=t-e,y_dif=i-s;var n=x_dif*x_dif+y_dif*y_dif;return n=Math.sqrt(n),[x_dif/n,y_dif/n]}function s(e,s){return t(e,s)<e.collision+s.collision}function t(e,s){var t=e.pos_x-s.pos_x,i=e.pos_y-s.pos_y;return Math.sqrt(t*t+i*i)}this.normalize=e,this.check_collision=s};utils=new p;var d=d||{levels:{}};d.levels[1]={charges:1,spots:{s1:{x:8,y:15,e:["s2",0]},s2:{x:20,y:15,w:[0,0],e:["s3",1]},s3:{x:35,y:15,w:["s2",1]}},paths:[["s1",3,12],["s2",3,15]],patrols:[],start:"s1",objectives:["s3"]};var d=d||{levels:{}};d.levels[2]={charges:0,spots:{s1:{x:8,y:15,e:["s2",0]},s2:{x:20,y:15,w:[0,0],e:["s3",1],n:["s4",2]},s3:{x:35,y:15,w:["s2",1],charge:!0},s4:{x:20,y:10,s:["s2",2]}},paths:[["s1",3,12],["s2",3,15],["s2",1,5]],patrols:[],start:"s1",objectives:["s4"]};var d=d||{levels:{}};d.levels[3]={charges:1,spots:{s1:{x:8,y:15,e:["s2",0]},s2:{x:12,y:15,w:["s1",0],e:["s4",1],n:["s3",2]},s3:{x:12,y:10,s:["s2",2]},s4:{x:16,y:15,w:["s2",1],e:["s5",3]},s5:{x:20,y:15,w:["s4",3],e:["s6",4]},s6:{x:24,y:15,w:["s5",4],e:["s7",5],s:["s8",6]},s7:{x:30,y:11,s:["s6",5]},s8:{x:30,y:19,w:["s6",6]}},paths:[["s1",3,4],["s2",3,4],["s2",1,5],["s4",3,4],["s5",3,4],["s6",3,3,2,3,1,1],["s6",5,2,4,2,3,4]],start:"s1",objectives:["s7"],patrols:[["s3","s2","s4","s5","s6","s8","s6","s5","s4","s2"]]};var d=d||{levels:{}};d.levels[4]={charges:1,spots:{s1:{x:9,y:7,s:["s2",0]},s2:{x:10,y:12,n:["s1",0],e:["s3",1]},s3:{x:14,y:12,w:["s2",1],e:["s4",2],n:["s7",5]},s4:{x:22,y:14,w:["s3",2],e:["s5",3],s:["s6",4]},s5:{x:25,y:11,s:["s4",3]},s6:{x:20,y:17,e:["s4",4]},s7:{x:20,y:8,w:["s3",5]}},paths:[["s1",5,2,4,1,5,2],["s2",3,4],["s3",3,2,4,2,3,4],["s4",3,2,2,1,1,2],["s4",5,2,6,1,7,1],["s3",1,2,2,2,3,4]],start:"s1",objectives:["s5"],patrols:[["s6","s4","s3","s4"]]}}();