!function(){var e,t=function(){function e(){x.charges&&(x.charges--,f.detonate_charge(d))}function t(){var e=utils.normalize(x.pos_x,x.pos_y,p[v].x,p[v].y);x.vol_x=e[0]*x.speed,x.vol_y=e[1]*x.speed}function n(e){function s(){x.pos_x=p[v].x,x.pos_y=p[v].y,v++,v>=p.length?i(next_spot):t()}y&&(x.pos_x+=x.vol_x*e,x.pos_y+=x.vol_y*e,x.vol_x>0&&x.pos_x>p[v].x?s():x.vol_x<0&&x.pos_x<p[v].x&&s(),x.vol_y>0&&x.pos_y>p[v].y?s():x.vol_y<0&&x.pos_y<p[v].y&&s())}function i(e){d=e,y=!1,x.pos_x=e.x*s.grid_size,x.pos_y=e.y*s.grid_size,e.charge&&(x.charges++,e.charge=!1)}function o(){i(f.starting_spot)}function a(e){n(e)}function r(){return x}function c(e){u=e,u.add_subscriber(this)}function _(s){if(!y){if(" "===s)return void e();var n=f.move_leads_to(d,g[s]);n&&(p=n.path.checkpoints.slice(0),p[0].x===x.pos_x&&p[0].y===x.pos_y||p.reverse(),v=1,next_spot=n.spot,t(),y=!0)}}function l(e){f=e}function h(e){x.charges=e}var u,f,p,v,d,g={a:"west",s:"south",d:"east",w:"north"},x={pos_x:0,pos_y:0,vol_x:0,vol_y:0,speed:500,charges:0},y=!1;this.update=a,this.get_avatar=r,this.start_level=o,this.inject_input=c,this.key_pressed=_,this.inject_level_manager=l,this.set_avatar_charges=h},s={canvas_id:"game_canvas",fps:60,grid_size:15,FOREGROUND:1,BACKGROUND:0,direction_to_grid_difference:{1:{x:0,y:-1},2:{x:1,y:-1},3:{x:1,y:0},4:{x:1,y:1},5:{x:0,y:1},6:{x:-1,y:1},7:{x:-1,y:0},8:{x:-1,y:-1}}},n=!1;window.onload=function(t){e=new o};var o=function(){function e(e){n&&t.update(e)}var t=new a;graphics=new r,input=new c,t.inject_graphics(graphics),t.inject_input(input);var i=function(){var t=1e3/s.fps;next_tick=last_tick=(new Date).getTime();return num_frames=0,function(){for(current_tick=(new Date).getTime();current_tick>next_tick;)delta=(current_tick-last_tick)/1e3,e(delta),next_tick+=t,last_tick=(new Date).getTime();graphics.draw(),num_frames++}}();document.oncontextmenu=document.body.oncontextmenu=function(){return!1},window.requestAnimationFrame?window.each_frame=function(e){var t=function(){e(),requestAnimationFrame(t)};t()}:window.mozRequestAnimationFrame?window.each_frame=function(e){var t=function(){e(),mozRequestAnimationFrame(t)};t()}:window.each_frame=function(e){setInterval(e,1e3/s.fps)},window.each_frame(i),t.start_game()},a=function(){function e(e){h.update(e),level_manager.update(e)}function s(e){r=e,r.inject_avatar(h.get_avatar()),level_manager.inject_graphics(e)}function n(e){c=e,h.inject_input(e)}function i(){l=3,o()}function o(){level_manager.clear_level(),level_manager.setup_level(l),h.start_level()}function a(){l++,o()}var r,c,l,h=new t;level_manager=new _,h.inject_level_manager(level_manager),level_manager.inject_avatar_manager(h),level_manager.inject_game_master(this),this.update=e,this.inject_graphics=s,this.inject_input=n,this.start_game=i,this.level_complete=a},r=function(){function e(){g.clearRect(0,0,w,j),_(),o(),f(),g.save(),g.lineWidth=0,g.fillStyle="rgba(95,232,232,0.7)",g.beginPath(),g.arc(v.pos_x,v.pos_y,10,0,2*Math.PI,!0),g.closePath(),g.fill(),g.restore()}function t(e){v=e}function n(){x=[],y=[],m=[]}function i(e){y.indexOf(e)===-1&&y.push(e)}function o(){g.save();for(var e=0;e<y.length;e++)a(y[e]);g.restore()}function a(e){g.strokeStyle="#cc3399",g.fillStyle="rgba(204, 51, 153, 0.8)",g.beginPath(),g.arc(e.x*s.grid_size,e.y*s.grid_size,s.grid_size,0,2*Math.PI,!0),g.closePath(),g.stroke(),g.fill(),e.charge&&r(e)}function r(e){g.strokeStyle="#8888DD",g.fillStyle="#8888DD",g.arc(e.x*s.grid_size,e.y*s.grid_size,4,0,2*Math.PI,!0),g.closePath(),g.stroke(),g.fill()}function c(e){x.indexOf(e)===-1&&x.push(e)}function _(){g.save(),g.lineWidth=7,g.strokeStyle="#33cc33";for(var e=0;e<x.length;e++)l(x[e]);g.restore()}function l(e){g.moveTo(e[0].x,e[0].y);for(var t=1;t<e.length;t++)g.lineTo(e[t].x,e[t].y);g.stroke()}function h(e){m.indexOf(e)===-1&&m.push(e)}function u(e){m.indexOf(e)!==-1&&m.splice(m.indexOf(e),1)}function f(){g.save(),g.lineWidth=1,g.strokeStyle="#000000",g.fillStyle="rgba(51, 204, 204, 0.8)";for(var e=0;e<m.length;e++)p(m[e]);g.restore()}function p(e){var t=e.spot.x*s.grid_size,n=e.spot.y*s.grid_size,i=20;g.moveTo(t-i,n-i),g.lineTo(t+i,n-i),g.lineTo(t+i,n+i),g.lineTo(t-i,n+i),g.lineTo(t-i,n-i),g.fill(),g.stroke()}var v,d=document.getElementById(s.canvas_id),g=d.getContext("2d"),x=[],y=[],m=[],w=d.width,j=d.height;this.draw=e,this.add_spot=i,this.add_path=c,this.clear_level=n,this.add_objective=h,this.remove_objective=u,this.inject_avatar=t},c=function(){function e(e){s.indexOf(e)===-1&&s.push(e)}function t(e){s.indexOf(e)!==-1&&e.splice(s.indexOf(e),1)}var s=[];window.addEventListener("keydown",function(e){for(var t=0;t<s.length;t++)s[t].key_pressed(e.key)}),this.add_subscriber=e,this.remove_subscriber=t},_=function(){function e(e){p=v.levels[String(e)],g.set_avatar_charges(p.charges);for(var t in p.spots){var s=new f(p.spots[t]);y[t]=s,d.add_spot(s)}for(this.starting_spot=y[p.start],i=0;i<p.paths.length;i++){var o=new h(p.paths[i]);o.inject_graphics(d),o.set_starting_spot(y[p.paths[i][0]]),m.push(o)}for(i=0;i<p.objectives.length;i++){var a=new l(y[p.objectives[i]]);d.add_objective(a),w.push(a)}for(i=0;i<p.patrols.length;i++){var r=new u(p.patrols[i]);r.make_path_list(m,y),j.push(r)}n=!0}function t(e,t){return!!e[t]&&{spot:y[e[t][0]],path:m[e[t][1]]}}function s(e){d=e}function o(e){g=e}function a(e){x=e}function r(e){for(var t=0;t<w.length;t++)w[t].spot==e&&(w[t].blow_up(),d.remove_objective(w[t]),w.splice(t,1),w.length||x.level_complete())}function c(){d.clear_level(),y={},m=[],w=[],j=[]}function _(e){for(var t=0;t<j.length;t++)j[t].update(e)}var p,d,g,x,y,m,w,j;this.starting_spot,this.setup_level=e,this.inject_graphics=s,this.inject_avatar_manager=o,this.inject_game_master=a,this.move_leads_to=t,this.detonate_charge=r,this.clear_level=c,this.update=_},l=function(e){function t(){}this.spot=e,this.blow_up=t},h=function(e){function t(e){a=e,this.checkpoints=i(),o.add_path(r)}function n(e){o=e}function i(){r=[],r.push({x:a.x*s.grid_size,y:a.y*s.grid_size});for(var t,n,i=1;i<e.length;i+=2)t=e[i],n=e[i+1],r.push({x:s.direction_to_grid_difference[t].x*s.grid_size*n+r[r.length-1].x,y:s.direction_to_grid_difference[t].y*s.grid_size*n+r[r.length-1].y});return r}var o,a,r;this.set_starting_spot=t,this.inject_graphics=n,this.checkpoints=r},u=function(e){function t(e,t){r=[];for(var n=0;n<u.length;n++)r.push(e[s(t[u[n]],u[(n+1)%u.length])]);_=-1,l=1,o()}function s(e,t){for(var s=0;s<v.length;s++)if(e[v[s]]&&e[v[s]][0]==t)return e[v[s]][1]}function n(e){i(e)}function i(e){function t(){f.pos_x=c[h].x,f.pos_y=c[h].y,h++,h>=c.length?o():a()}p&&(f.pos_x+=f.vol_x*e,f.pos_y+=f.vol_y*e,f.vol_x>0&&f.pos_x>c[h].x?t():f.vol_x<0&&f.pos_x<c[h].x&&t(),f.vol_y>0&&f.pos_y>c[h].y?t():f.vol_y<0&&f.pos_y<c[h].y&&t())}function o(){_=(_+l+u.length)%u.length,console.log(_),c=r[_].checkpoints.slice(0),c[0].x===f.pos_x&&c[0].y===f.pos_y||c.reverse(),h=1,a()}function a(){var e=utils.normalize(f.pos_x,f.pos_y,c[h].x,c[h].y);f.vol_x=e[0]*f.speed,f.vol_y=e[1]*f.speed}var r,c,_,l,h,u=e,f={pos_x:0,pos_y:0,vol_x:0,vol_y:0,speed:75},p=!0,v=["north","east","west","south"];this.make_path_list=t,this.update=n},f=function(e){this.x=e.x,this.y=e.y,this.north=e.n,this.east=e.e,this.south=e.s,this.west=e.w,this.charge=e.charge||!1},p=function(){this.normalize=function(e,t,s,n){x_dif=s-e,y_dif=n-t;var i=x_dif*x_dif+y_dif*y_dif;return i=Math.sqrt(i),[x_dif/i,y_dif/i]}};utils=new p;var v=v||{levels:{}};v.levels[1]={charges:1,spots:{s1:{x:8,y:15,e:["s2",0]},s2:{x:20,y:15,w:[0,0],e:["s3",1]},s3:{x:35,y:15,w:["s2",1]}},paths:[["s1",3,12],["s2",3,15]],patrols:[],start:"s1",objectives:["s3"]};var v=v||{levels:{}};v.levels[2]={charges:0,spots:{s1:{x:8,y:15,e:["s2",0]},s2:{x:20,y:15,w:[0,0],e:["s3",1],n:["s4",2]},s3:{x:35,y:15,w:["s2",1],charge:!0},s4:{x:20,y:10,s:["s2",2]}},paths:[["s1",3,12],["s2",3,15],["s2",1,5]],patrols:[],start:"s1",objectives:["s4"]};var v=v||{levels:{}};v.levels[3]={charges:1,spots:{s1:{x:8,y:15,e:["s2",0]},s2:{x:12,y:15,w:["s1",0],e:["s4",1],n:["s3",2]},s3:{x:12,y:10,s:["s2",2]},s4:{x:16,y:15,w:["s2",1],e:["s5",3]},s5:{x:20,y:15,w:["s4",3],e:["s6",4]},s6:{x:24,y:15,w:["s5",4],e:["s7",5],s:["s8",6]},s7:{x:30,y:11,s:["s6",5]},s8:{x:30,y:19,w:["s6",6]}},paths:[["s1",3,4],["s2",3,4],["s2",1,5],["s4",3,4],["s5",3,4],["s6",3,3,2,3,1,1],["s6",5,2,4,2,3,4]],start:"s1",objectives:["s7"],patrols:[["s3","s2","s4","s5","s6","s8","s6","s5","s4","s2"]]}}();