!function(){function t(t,e,s,i){O.beginPath(),O.moveTo(t,e),O.lineTo(s,i),O.closePath(),O.stroke()}function e(){this.points=[{y:Math.floor(Math.random()*j+1)*v,x:Math.floor(Math.random()*T+1)*v}],this.draw=i,this.move=s,this.dir=Math.floor(8*Math.random()+1)}function s(){var t=Math.floor(3*Math.random()-1),e=this.dir+t;e<0&&(e=7),7<e&&(e=0);var s=this.points[this.points.length-1];s.x<10&&(e=2),s.y<10&&(e=4),d.width-10<s.x&&(e=6),d.height-10<s.y&&(e=0),this.dir=e;var i={x:s.x+P[e].x*v,y:s.y+P[e].y*v};this.points.push(i),10<this.points.length&&this.points.shift()}function i(){var t=this.points;for(m=1;m<t.length;m++)u.beginPath(),u.moveTo(t[m-1].x,t[m-1].y),u.lineTo(t[m].x,t[m].y),u.closePath(),u.lineWidth=1,u.strokeStyle=w,u.stroke(),u.lineWidth=10,u.strokeStyle=b,u.stroke()}function n(t){this.snakeys=[];for(var s=0;s<t;s++)this.snakeys.push(new e);this.go=o}function o(){for(var t=0;t<this.snakeys.length;t++)this.snakeys[t].move(),this.snakeys[t].draw()}var a,r=function(){function t(){x.charges&&(x.charges--,g.detonate_charge(u))}function e(){var t=utils.normalize(x.pos_x,x.pos_y,p[d].x,p[d].y);x.vol_x=t[0]*x.speed,x.vol_y=t[1]*x.speed}function s(t){function s(){x.pos_x=p[d].x,x.pos_y=p[d].y,d++,d>=p.length?i(next_spot):e()}y&&(x.pos_x+=x.vol_x*t,x.pos_y+=x.vol_y*t,x.vol_x>0&&x.pos_x>p[d].x?s():x.vol_x<0&&x.pos_x<p[d].x&&s(),x.vol_y>0&&x.pos_y>p[d].y?s():x.vol_y<0&&x.pos_y<p[d].y&&s())}function i(t){u=t,y=!1,x.pos_x=t.x*l.grid_size,x.pos_y=t.y*l.grid_size,t.charge&&(x.charges++,t.charge=!1),x.collision=8}function n(){i(g.starting_spot)}function o(t){s(t)}function a(){return x}function r(t){_=t,_.add_subscriber(this)}function h(s){if(!y){if(" "===s)return void t();var i=g.move_leads_to(u,v[s]);i&&(p=i.path.checkpoints.slice(0),p[0].x===x.pos_x&&p[0].y===x.pos_y||p.reverse(),d=1,next_spot=i.spot,e(),y=!0,x.collision=2)}}function c(t){g=t}function f(t){x.charges=t}var _,g,p,d,u,v={a:"west",s:"south",d:"east",w:"north"},x={pos_x:0,pos_y:0,vol_x:0,vol_y:0,speed:500,charges:0,collision:10},y=!1;this.update=o,this.get_avatar=a,this.start_level=n,this.inject_input=r,this.key_pressed=h,this.inject_level_manager=c,this.set_avatar_charges=f},l={canvas_id:"game_canvas",fps:60,grid_size:15,FOREGROUND:1,BACKGROUND:0,direction_to_grid_difference:{1:{x:0,y:-1},2:{x:1,y:-1},3:{x:1,y:0},4:{x:1,y:1},5:{x:0,y:1},6:{x:-1,y:1},7:{x:-1,y:0},8:{x:-1,y:-1}}};window.onload=function(t){a=new h};var h=function(){function t(t){c&&e.update(t)}var e=new f;graphics=new p,input=new M,e.inject_graphics(graphics),e.inject_input(input);var s=function(){var e=1e3/l.fps;next_tick=last_tick=(new Date).getTime();return num_frames=0,function(){for(current_tick=(new Date).getTime();current_tick>next_tick;)delta=(current_tick-last_tick)/1e3,t(delta),next_tick+=e,last_tick=(new Date).getTime();graphics.draw(),num_frames++}}();window.requestAnimationFrame?window.each_frame=function(t){var e=function(){t(),requestAnimationFrame(e)};e()}:window.mozRequestAnimationFrame?window.each_frame=function(t){var e=function(){t(),mozRequestAnimationFrame(e)};e()}:window.each_frame=function(t){setInterval(t,1e3/l.fps)},window.each_frame(s),e.start_game()},c=!1,f=function(){function t(t){_.update(t),level_manager.update(t)}function e(t){l=t,l.inject_avatar(_.get_avatar()),level_manager.inject_graphics(t)}function s(t){h=t,_.inject_input(t)}function i(){f=1,n()}function n(){level_manager.clear_level(),level_manager.setup_level(f),_.start_level(),c=!0}function o(){c=!1,f++,n()}function a(){c=!1,n()}var l,h,f,_=new r;level_manager=new S,_.inject_level_manager(level_manager),level_manager.inject_avatar_manager(_),level_manager.inject_game_master(this),this.update=t,this.inject_graphics=e,this.inject_input=s,this.start_game=i,this.level_complete=o,this.reset_level=a},_=function(t){function e(){}this.pos_x=t.x,this.pos_y=t.y,this.path=t.p,this.blow_up=e},g=function(t){function e(){}this.spot=t.s,this.gates=t.g,this.gate_paths=t.gp,this.blow_up=e},p=function(){function t(){B.clearRect(0,0,q,E),h(),n(),g(),v(),P(),m(),j(),B.save(),B.lineWidth=0,B.fillStyle="rgba(250,247,91,0.7)",B.shadowColor="#39b5a6",B.shadowBlur=5,B.shadowOffsetX=0,B.shadowOffsetY=0,B.beginPath(),B.arc(M.pos_x,M.pos_y,M.collision,0,2*Math.PI,!0),B.closePath(),B.fill(),B.restore(),B.font="bold 20px sans-serif",B.fillStyle="rgba(210,210,210,0.5)",B.fillText("Charges:"+M.charges,33,27)}function e(t){M=t}function s(){W=[],D=[],I=[],X=[],Y=[],A=[],R=[]}function i(t){D.indexOf(t)===-1&&D.push(t)}function n(){B.save();for(var t=0;t<D.length;t++)o(D[t]);B.restore()}function o(t){B.fillStyle="rgba(254, 254, 254, 0.8)",B.lineWidth=2,B.strokeStyle="#29c8df",B.shadowColor="#5ad4e6",B.shadowBlur=10,B.shadowOffsetX=0,B.shadowOffsetY=0,B.beginPath(),B.arc(t.x*l.grid_size,t.y*l.grid_size,l.grid_size/2,0,2*Math.PI,!0),B.closePath(),B.fill(),B.stroke(),t.charge&&a(t)}function a(t){B.fillStyle="rgba(212, 17, 27, 0.6)",B.shadowColor="#d0161e",B.shadowBlur=10,B.shadowOffsetX=0,B.shadowOffsetY=0,B.beginPath(),B.arc(t.x*l.grid_size,t.y*l.grid_size,4,0,2*Math.PI,!0),B.fill()}function r(t){W.indexOf(t)===-1&&W.push(t)}function h(){B.save(),B.lineWidth=2,B.strokeStyle="#d1f3f8",B.shadowColor="#6FC3DF",B.shadowBlur=5,B.shadowOffsetX=0,B.shadowOffsetY=0;for(var t=0;t<W.length;t++)c(W[t]);B.restore()}function c(t){B.moveTo(t[0].x,t[0].y);for(var e=1;e<t.length;e++)B.lineTo(t[e].x,t[e].y);B.stroke()}function f(t){I.indexOf(t)===-1&&I.push(t)}function _(t){I.indexOf(t)!==-1&&I.splice(I.indexOf(t),1)}function g(){B.save(),B.lineWidth=1,B.fillStyle="rgba(250,247,91,0.2)",B.shadowColor="#6FC3DF",B.shadowBlur=5,B.shadowOffsetX=0,B.shadowOffsetY=0;for(var t=0;t<I.length;t++)p(I[t]);B.restore()}function p(t){var e=t.spot.x*l.grid_size,s=t.spot.y*l.grid_size,i=15;B.beginPath(),B.moveTo(e-i,s-i),B.lineTo(e+i,s-i),B.lineTo(e+i,s+i),B.lineTo(e-i,s+i),B.lineTo(e-i,s-i),B.fill()}function d(t){X.indexOf(t)===-1&&X.push(t)}function u(t){X.indexOf(t)!==-1&&X.splice(X.indexOf(t),1)}function v(){for(var t=0;t<X.length;t++)x(X[t])}function x(t){B.save(),B.lineWidth=0,B.fillStyle="rgba(207, 19, 28, 0.8)",B.shadowColor="#6FC3DF",B.shadowBlur=20,B.shadowOffsetX=0,B.shadowOffsetY=0,B.beginPath(),B.arc(t.pos_x,t.pos_y,10,0,2*Math.PI,!0),B.fill(),B.restore()}function y(t){A.indexOf(t)===-1&&A.push(t)}function w(t){A.indexOf(t)!==-1&&A.splice(A.indexOf(t),1)}function m(){B.save(),B.lineWidth=1,B.fillStyle="rgba(204, 51, 51, 0.6)",B.shadowColor="#6FC3DF",B.shadowBlur=5,B.shadowOffsetX=0,B.shadowOffsetY=0;for(var t=0;t<A.length;t++)b(A[t]);B.restore()}function b(t){var e=t.pos_x*l.grid_size,s=t.pos_y*l.grid_size,i=10;B.beginPath(),B.moveTo(e-i,s-i),B.lineTo(e+i,s-i),B.lineTo(e+i,s+i),B.lineTo(e-i,s+i),B.lineTo(e-i,s-i),B.fill(),B.stroke()}function k(t){R.indexOf(t)===-1&&R.push(t)}function O(t){R.indexOf(t)!==-1&&R.splice(R.indexOf(t),1)}function j(){B.save(),B.lineWidth=1,B.fillStyle="rgba(204, 104, 51, 0.6)",B.shadowColor="#6FC3DF",B.shadowBlur=5,B.shadowOffsetX=0,B.shadowOffsetY=0;for(var t=0;t<R.length;t++)T(R[t]);B.restore()}function T(t){var e=t.spot.x*l.grid_size,s=t.spot.y*l.grid_size,i=10;B.beginPath(),B.moveTo(e-i,s-i),B.lineTo(e+i,s-i),B.lineTo(e+i,s+i),B.lineTo(e-i,s+i),B.lineTo(e-i,s-i),B.fill(),B.stroke()}function z(t){Y.indexOf(t)===-1&&Y.push(t)}function C(t){Y.indexOf(t)!==-1&&Y.splice(Y.indexOf(t),1)}function P(){B.save(),B.lineWidth=1,B.fillStyle="rgba(84, 84, 51, 0.6)",B.shadowColor="#6FC3DF",B.shadowBlur=5,B.shadowOffsetX=0,B.shadowOffsetY=0;for(var t=0;t<Y.length;t++)F(Y[t]);B.restore()}function F(t){var e=t.spot.x*l.grid_size,s=t.spot.y*l.grid_size,i=10;B.beginPath(),B.moveTo(e-i,s-i),B.lineTo(e+i,s-i),B.lineTo(e+i,s+i),B.lineTo(e-i,s+i),B.lineTo(e-i,s-i),B.fill(),B.stroke()}var M,S=document.getElementById(l.canvas_id),B=S.getContext("2d"),W=[],D=[],I=[],X=[],Y=[],A=[],R=[],q=S.width,E=S.height;this.draw=t,this.add_spot=i,this.add_path=r,this.clear_level=s,this.add_objective=f,this.remove_objective=_,this.inject_avatar=e,this.add_patrol=d,this.remove_patrol=u,this.add_gate=y,this.remove_gate=w,this.add_gate_generator=k,this.remove_gate_generator=O,this.add_patrol_generator=z,this.remove_patrol_generator=C},d=document.getElementById("text");d.width=window.innerWidth,d.height=window.innerHeight;var u=d.getContext("2d");u.translate(.5,.5);var v=12,x="rgba(240,240,240)",y="rgba(0,20,40,0.9)",w="rgba(0,255,255,0.1)",b="rgba(0,100,100,0.1)",k=document.createElement("canvas");k.width=window.innerWidth,k.height=window.innerHeight;var O=k.getContext("2d");O.translate(.5,.5),O.fillStyle=x,O.fillRect(0,0,k.width,k.height);var j=Math.ceil(k.height/v),T=Math.ceil(k.width/v);O.strokeStyle=y;for(var z=1;z<=T;z++)t(z*v,0,z*v,k.height);for(var C=0;C<=j;C++)t(0,C*v,k.width,C*v);for(var C=0;C<=j+T;C++)t(0,C*v-k.width,k.width,C*v),t(0,C*v,k.width,C*v-k.width);var P=[{name:"up",x:0,y:-1},{name:"upright",x:1,y:-1},{name:"right",x:1,y:0},{name:"downright",x:1,y:1},{name:"down",x:0,y:1},{name:"downleft",x:-1,y:1},{name:"left",x:-1,y:0},{name:"upleft",x:-1,y:-1}],F=new n(10);u.drawImage(k,0,0),setInterval(function(){u.globalAlpha=.2,u.drawImage(k,0,0),u.globalAlpha=1,F.go()},1e3/30);var M=function(){function t(t){s.indexOf(t)===-1&&s.push(t)}function e(t){s.indexOf(t)!==-1&&t.splice(s.indexOf(t),1)}var s=[];window.addEventListener("keydown",function(t){for(var e=0;e<s.length;e++)s[e].key_pressed(t.key)}),this.add_subscriber=t,this.remove_subscriber=e},S=function(){function t(t){l=A.levels[String(t)],c.set_avatar_charges(l.charges);for(var e in l.spots){var s=new X(l.spots[e]);p[e]=s,h.add_spot(s)}for(this.starting_spot=p[l.start],C=0;C<l.paths.length;C++){var i=new W(l.paths[C]);i.inject_graphics(h),i.set_starting_spot(p[l.paths[C][0]]),d.push(i)}for(C=0;C<l.objectives.length;C++){var n=new B(p[l.objectives[C]]);h.add_objective(n),u.push(n)}for(C=0;C<l.patrols.length;C++){var o=new D(l.patrols[C]);o.make_path_list(d,p),o.inject_graphics(h),v.push(o)}for(C=0;C<l.patrol_generators.length;C++){var a=new I(l.patrol_generators[C]);a.spot=p[a.spot],h.add_patrol_generator(a),x.push(a)}for(C=0;C<l.gates.length;C++){var r=new _(l.gates[C]);d[r.path].blocked=!0,h.add_gate(r),y.push(r)}for(C=0;C<l.gate_generators.length;C++){var f=new g(l.gate_generators[C]);f.spot=p[f.spot],h.add_gate_generator(f),w.push(f)}}function e(t,e){if(!t[e])return!1;var s={spot:p[t[e][0]],path:d[t[e][1]]};return!s.path.blocked&&s}function s(t){h=t}function i(t){c=t}function n(t){f=t}function o(t){for(var e=0;e<u.length;e++)u[e].spot==t&&(u[e].blow_up(),h.remove_objective(u[e]),u.splice(e,1),u.length||f.level_complete());for(e=0;e<x.length;e++)if(x[e].spot==t){x[e].blow_up();for(var s=0;s<x[e].patrols.length;s++)v[x[e].patrols[s]].blow_up(),h.remove_patrol(v[x[e].patrols[s]].get_unit()),v.splice(v.indexOf(v[x[e].patrols[s]]),1),h.remove_patrol_generator(x[e])}for(e=0;e<w.length;e++)if(w[e].spot==t){w[e].blow_up();for(var i=0;i<w[e].gates.length;i++)y[w[e].gates[i]].blow_up(),h.remove_gate(y[w[e].gates[i]]),d[y[w[e].gates[i]].path].blocked=!1,h.remove_gate_generator(w[e])}}function a(){h.clear_level(),p={},d=[],u=[],v=[],x=[],y=[],w=[]}function r(t){for(var e=0;e<v.length;e++)v[e].update(t),utils.check_collision(v[e].get_unit(),c.get_avatar())&&f.reset_level()}var l,h,c,f,p,d,u,v,x,y,w;this.starting_spot,this.setup_level=t,this.inject_graphics=s,this.inject_avatar_manager=i,this.inject_game_master=n,this.move_leads_to=e,this.detonate_charge=o,this.clear_level=a,this.update=r},B=function(t){function e(){}this.spot=t,this.blow_up=e},W=function(t){function e(t){o=t,this.checkpoints=i(),n.add_path(a)}function s(t){n=t}function i(){a=[],a.push({x:o.x*l.grid_size,y:o.y*l.grid_size});for(var e,s,i=1;i<t.length;i+=2)e=t[i],s=t[i+1],a.push({x:l.direction_to_grid_difference[e].x*l.grid_size*s+a[a.length-1].x,y:l.direction_to_grid_difference[e].y*l.grid_size*s+a[a.length-1].y});return a}var n,o,a;this.set_starting_spot=e,this.inject_graphics=s,this.checkpoints=a},D=function(t){function e(t){f=t,f.add_patrol(x)}function s(t,e){_=[];for(var s=0;s<v.length;s++)_.push(t[i(e[v[s]],v[(s+1)%v.length])]);x.pos_x=e[v[0]].x*l.grid_size,x.pos_y=e[v[0]].y*l.grid_size,p=-1,d=1,a()}function i(t,e){for(var s=0;s<w.length;s++)if(t[w[s]]&&t[w[s]][0]==e)return t[w[s]][1]}function n(t){o(t)}function o(t){function e(){x.pos_x=g[u].x,x.pos_y=g[u].y,u++,u>=g.length?a():r()}y&&(x.pos_x+=x.vol_x*t,x.pos_y+=x.vol_y*t,x.vol_x>0&&x.pos_x>g[u].x?e():x.vol_x<0&&x.pos_x<g[u].x&&e(),x.vol_y>0&&x.pos_y>g[u].y?e():x.vol_y<0&&x.pos_y<g[u].y&&e())}function a(){p=(p+d+v.length)%v.length,g=_[p].checkpoints.slice(0),g[0].x===x.pos_x&&g[0].y===x.pos_y||g.reverse(),u=1,r()}function r(){var t=utils.normalize(x.pos_x,x.pos_y,g[u].x,g[u].y);x.vol_x=t[0]*x.speed,x.vol_y=t[1]*x.speed}function h(){return x}function c(){}var f,_,g,p,d,u,v=t,x={pos_x:0,pos_y:0,vol_x:0,vol_y:0,speed:75,collision:10},y=!0,w=["north","east","west","south"];this.make_path_list=s,this.update=n,this.inject_graphics=e,this.get_unit=h,this.blow_up=c},I=function(t){function e(){}this.spot=t.s,this.patrols=t.p,this.blow_up=e},X=function(t){this.x=t.x,this.y=t.y,this.north=t.n,this.east=t.e,this.south=t.s,this.west=t.w,this.charge=t.charge||!1},Y=function(){function t(t,e,s,i){x_dif=s-t,y_dif=i-e;var n=x_dif*x_dif+y_dif*y_dif;return n=Math.sqrt(n),[x_dif/n,y_dif/n]}function e(t,e){return s(t,e)<t.collision+e.collision}function s(t,e){var s=t.pos_x-e.pos_x,i=t.pos_y-e.pos_y;return Math.sqrt(s*s+i*i)}this.normalize=t,this.check_collision=e};utils=new Y;var A=A||{levels:{}};A.levels[1]={charges:1,spots:{s1:{x:8,y:15,e:["s2",0]},s2:{x:20,y:15,w:["s1",0],e:["s3",1]},s3:{x:35,y:15,w:["s2",1]}},paths:[["s1",3,12],["s2",3,15]],patrols:[],patrol_generators:[],start:"s1",objectives:["s3"],gates:[],gate_generators:[]};var A=A||{levels:{}};A.levels[2]={charges:0,spots:{s1:{x:8,y:15,e:["s2",0]},s2:{x:20,y:15,w:["s1",0],e:["s3",1],n:["s4",2]},s3:{x:35,y:15,w:["s2",1],charge:!0},s4:{x:20,y:10,s:["s2",2]}},paths:[["s1",3,12],["s2",3,15],["s2",1,5]],patrols:[],patrol_generators:[],start:"s1",objectives:["s4"],gates:[],gate_generators:[]};var A=A||{levels:{}};A.levels[3]={charges:1,spots:{s1:{x:8,y:15,e:["s2",0]},s2:{x:12,y:15,w:["s1",0],e:["s4",1],n:["s3",2]},s3:{x:12,y:10,s:["s2",2]},s4:{x:16,y:15,w:["s2",1],e:["s5",3]},s5:{x:20,y:15,w:["s4",3],e:["s6",4]},s6:{x:24,y:15,w:["s5",4],e:["s7",5],s:["s8",6]},s7:{x:30,y:11,s:["s6",5]},s8:{x:30,y:19,w:["s6",6]}},paths:[["s1",3,4],["s2",3,4],["s2",1,5],["s4",3,4],["s5",3,4],["s6",3,3,2,3,1,1],["s6",5,2,4,2,3,4]],start:"s1",objectives:["s7"],patrols:[["s3","s2","s4","s5","s6","s8","s6","s5","s4","s2"]],patrol_generators:[{s:"s8",p:[0]}],gates:[],gate_generators:[]};var A=A||{levels:{}};A.levels[4]={charges:2,spots:{s1:{x:9,y:7,s:["s2",0]},s2:{x:10,y:12,n:["s1",0],e:["s3",1]},s3:{x:14,y:12,w:["s2",1],e:["s4",2],n:["s7",5]},s4:{x:22,y:14,w:["s3",2],e:["s5",3],s:["s6",4]},s5:{x:25,y:11,s:["s4",3]},s6:{x:20,y:17,e:["s4",4]},s7:{x:20,y:8,w:["s3",5]}},paths:[["s1",5,2,4,1,5,2],["s2",3,4],["s3",3,2,4,2,3,4],["s4",3,2,2,1,1,2],["s4",5,2,6,1,7,1],["s3",1,2,2,2,3,4]],start:"s1",objectives:["s5"],patrols:[["s6","s4","s3","s4"]],patrol_generators:[{s:"s6",p:[0]}],gates:[{x:20,y:14,p:2}],gate_generators:[{s:"s7",g:[0],gp:[[5,6]]}]};var A=A||{levels:{}};A.levels[5]={charges:1,spots:{s1:{x:8,y:20,n:["s2",0]},s2:{x:9,y:13,s:["s1",0],n:["s3",1],e:["s4",2]},s3:{x:6,y:12,n:["s2",1],charge:!0},s4:{x:16,y:15,w:["s2",2],s:["s5",3],e:["s7",6]},s5:{x:15,y:20,n:["s4",3],s:["s6",4]},s6:{x:22,y:20,w:["s5",4],n:["s7",5]},s7:{x:19,y:15,w:["s4",6],s:["s6",5],e:["s8",7]},s8:{x:23,y:10,s:["s7",7],w:["s9",8]},s9:{x:19,y:11,e:["s8",8]}},paths:[["s1",1,3,2,1,1,3],["s2",1,2,2,1,1,3,8,1,7,3,6,1,5,2,4,1,5,2],["s2",3,2,4,2,3,3],["s4",5,2,6,1,5,2],["s5",5,1,6,9,3,1,2,10,3,1,6,10,3,1,2,10,3,1,6,10,3,1,2,10,3,1],["s6",1,1,8,3,1,1],["s4",3,3],["s7",3,2,2,2,1,3],["s8",7,2,6,1,7,1]],start:"s1",objectives:["s8"],patrols:[["s5","s4","s7","s6"]],patrol_generators:[{s:"s5",p:[0]}],gates:[{x:18,y:15,p:6}],gate_generators:[{s:"s9",g:[0],gp:[[5,6]]}]}}();